---
title: "linear mixed effect model"
author: "liuc"
date: "10/28/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## linear mixed effect model
对于医学中常见的纵向数据，同一个受试者在不同时间的因变量值是相关的，不同受试者的因变量值仍可以认为独立。线性混合模型用来解释因变量的连续型和分类型自变量的作用称为*固定效应*， 个体之间的差别的影响称为*随机效应*。

```{r}
library(tidyverse)
library(easystats)
library(lme4)
library(lmerTest)
library(ggeffects)

# data(package = 'lme4')
```

## use lmer

```{r}
# same df2 data as in gee.Rmd
# 以入组后的2次测量值为因变量， 以处理效应、时间效应等为固定效应， 以不同病人作为随机效
lme_model <- 
  lme4::lmer(score ~ time * class + AGE + (1|`PatientID`),
             data = df2
             )
summary(lme_model)
```

**结果解读：**lme模型和gee.Rmd中的示例为同一数据，我们在只考虑随机截距的情况下，Fixed effects中Estimate值和gee结果保持一致，说明自变量。random effects为随机效应， Group列为随机效应因素

```{r}
# to see all 134 models
coef(lme_model)

library(ggeffects)

plot(ggemmeans(lme_model, terms = c("time", "class"), 
               condition = c(diagnose = "severe"))) + 
  ggplot2::ggtitle("GLMER Effect plot")
```

```{r}

ggpredict(
  model = lme_model,
  terms = c('time', 'class')
)

(lme_pre <- ggpredict(
  model = lme_model,
  terms = c('time', 'class'),
  type = 'random'
))
```

use easystats to get model parameter or effectsize or performance

```{r}
performance::performance(lme_model)

# insight::get_variance(lme_model) # show all variance

parameters::parameters(lme_model)
```

use glmer 广义混合模型

```{r}
glme_model <- 
  lme4::glmer(
    score ~ time * class + AGE + (1|`PatientID`),
             data = df2,
             family = 'gaussian'
  )

summary(glme_model)
```

```{r}

compare_performance(lme_model, glme_model)

plot(compare_performance(lme_model, glme_model))
```
