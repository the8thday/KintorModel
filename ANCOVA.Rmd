---
title: "ANCOVA"
author: "liuc"
date: "2/11/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## åæ–¹å·®åˆ†æ

æ­¤æ–‡é€šè¿‡ä¸€ä¸ªå°ç¤ºä¾‹è®°å½•åæ–¹å·®åˆ†æä»¥åŠè®¡ç®— emmeansæ—¶çš„åº”ç”¨ã€‚ æ¯”å¦‚åœ¨å…·æœ‰ä¸»è¦ç»“å±€æŒ‡æ ‡çš„é‡å¤æµ‹é‡æ•°æ®åˆ†æä¸­ï¼Œ ä»¥baselineä½œä¸ºåå˜é‡ï¼Œä»¥æŸä¸€æ—¶æœŸçš„ç»“æœä½œä¸ºä¸»è¦ç»“å±€å˜é‡ï¼Œåˆ™é€šå¸¸ä¼šé‡‡ç”¨åå˜é‡çš„æ–¹æ³•è¿›è¡Œåˆ†æã€‚
åå˜é‡åˆ†æçš„æ•ˆåº”å€¼å°±æ˜¯çŸ«æ­£è¿‡çš„åœ¨å„ä¸ªåˆ†ç»„ä¸­çš„å‡å€¼ï¼Œåæ–¹å·®åˆ†æçš„è‡ªå˜é‡è‡³å°‘åŒ…æ‹¬ä¸€ä¸ªåˆ†ç±»å˜é‡å’Œä¸€ä¸ªæ•°å€¼å‹å˜é‡ã€‚

emmeansä¸ºåœ¨å„ä¸ªåˆ†ç»„ä¸­outcomeçš„å‡å€¼ï¼›contrastsä¸ºä¸åŒåˆ†ç»„é—´çš„å·®å¼‚ï¼Œæ±‡æŠ¥çš„ç»“æœä¸€èˆ¬è¿˜éœ€è¦åŒ…æ‹¬Pvalueå’Œ95%CIã€‚

*å¯¹äºå¦‚ä½•çº³å…¥äº¤äº’ä½œç”¨çš„ä¸€äº›è®°å½•ï¼š*ä¸»è¦æŒ‡two-wayåˆ†æä¸­ä¸¤åˆ†ç»„å˜é‡é—´çš„äº¤äº’ã€‚
è™½åˆ™ä¸€èˆ¬åœ¨ä¸»è¦ç ”ç©¶ç»ˆç‚¹ä¸Šä¸ä¼šå¼•å…¥äº¤äº’ä½œç”¨ï¼Œä½†åç»­çš„æ¬¡è¦ç»ˆç‚¹ç ”ç©¶æ˜¯å¯ä»¥è€ƒè™‘äº¤äº’ä½œç”¨çš„ã€‚
When using frequentist methods, it is invalid to remove the interaction from a linear model just because of a hypothesis test, because that invalidates the estimate of residual variance, i.e., it results in an underestimation of ğœ2. This is a form of model uncertainty discussed at more length in RMS.

In a confirmatory randomized experiment it is commonplace to have a "no interaction" model for the primary analysis and a pre-specified secondary analysis using an interaction model. The most cohesive approach IMHO is a Bayesian analysis in which the prior distribution for the interaction effect is elicited before data analysis. This allows interactions to be "half in" and "half out" of the model.

å¯¹äºäº¤äº’ä½œç”¨ä¸»è¦å¦‚æ­¤è€ƒè™‘ï¼šå¦‚æœç ”ç©¶ç›®çš„æœ‰å¿…è¦å»è€ƒè™‘äº¤äº’ä½œç”¨ï¼Œåˆ™ä¸è®ºæ˜¯å¦P<0.05ï¼Œéƒ½æŒ‰ç…§åˆ†ç»„é—´åšåˆ†æã€‚å¦‚æœåªæ˜¯æ¢ç´¢æ€§çš„åˆ†æï¼Œåˆ™åœ¨<0.05çš„æ—¶å€™ï¼ŒæŒ‰ç…§ä¸€ä¸ªåˆ†ç»„å»åˆ†æå¦ä¸€ä¸ªåˆ†ç»„çš„äºšç»„åˆ†æï¼›å¦‚æœ>0.05ï¼Œåˆ™å¯ä»¥è§‚å¯Ÿå…·ä½“æœ‰æ„ä¹‰çš„åˆ†ç»„å˜é‡æˆ–è€…ç›´æ¥å°±åšä¸¤ä¸ªå•ç‹¬çš„ANCOVAã€‚


```{r, include=FALSE}
library(tidyverse)
library(easystats)
library(rstatix)
library(grafify)
library(emmeans)
library(marginaleffects)
```


```{r}
df <- readr::read_rds('./datasets/foo3.rds')

# æ­¤æ•°æ®é›†ä¸­ä»¥W24D1ä½œä¸ºä¸»è¦ç»“å±€æŒ‡æ ‡ã€‚
# W1D1ä½œä¸ºåå˜é‡ï¼Œå¯ä»¥ç†è§£ä¸ºW1ä¸ºbaslineæ•°æ®
# ç ”ç©¶é¡¹ç›®åˆ†ç»„ ä¸ºåˆ†ç±»å˜é‡ã€‚

skimr::skim(df)
```

é¦–å…ˆæ˜¯å¦æ»¡è¶³çš„åˆ†ææ¡ä»¶ï¼Œå’Œä¸€èˆ¬çº¿æ€§å›å½’ä¸€æ ·ï¼Œéœ€è¦æ»¡è¶³LINEï¼ŒåŒæ—¶è¿˜éœ€è¦åå˜é‡å’Œå› å˜é‡ä¹‹é—´ä¸å­˜åœ¨äº¤äº’æ•ˆåº”ã€‚
ä»¥ä¸‹åˆ†æ­¥éª¤æ‰€åšçš„æ£€æµ‹ï¼Œäº¦å¯åœ¨æ¨¡å‹å»ºç«‹åperformance::check_modelè¿›è¡Œï¼ˆæ¨èï¼‰ã€‚

*å¯¹äºä¸æ»¡è¶³æ¡ä»¶çš„ï¼Œå¯ä»¥ç”¨småŒ…çš„éå‚æ•°æ£€éªŒæ–¹æ³•çš„sm.ancova()å‡½æ•°è¿›è¡Œåˆ†æã€‚*

```{r}
# raw means
# å¯ä»¥åˆæ­¥çœ‹å¾…ä¸‹ä¸åŒåˆ†ç»„ä¸­çš„raw means
df %>% select(W1D1, `ç ”ç©¶é¡¹ç›®åˆ†ç»„`, diffW24) %>% distinct() %>% 
  group_by(`ç ”ç©¶é¡¹ç›®åˆ†ç»„`) %>% summarise(mm = mean(diffW24))


# æ­£æ€æ€§
df %>% group_by(`ç ”ç©¶é¡¹ç›®åˆ†ç»„`) %>% identify_outliers(diffW24)
df %>% group_by(`ç ”ç©¶é¡¹ç›®åˆ†ç»„`) %>% shapiro_test(diffW24)
df %>% levene_test(diffW24 ~ `ç ”ç©¶é¡¹ç›®åˆ†ç»„`)

# çº¿æ€§ï¼Œä¸åŒåˆ†ç»„
ggpubr::ggscatter(
  df, x = "W1D1", y = "diffW24",
  color = "ç ”ç©¶é¡¹ç›®åˆ†ç»„", add = "reg.line"
)+
  ggpubr::stat_regline_equation(
    aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~"), color = `ç ”ç©¶é¡¹ç›®åˆ†ç»„`)
  )

# å› å˜é‡å’Œåå˜é‡çš„äº¤äº’æ•ˆåº”, å¦‚æœæœ‰äº¤äº’æ•ˆåº”åº”è¯¥æ€ä¹ˆå¤„ç†å‘¢
anova_test(data = df,
       formula = diffW24 ~ `ç ”ç©¶é¡¹ç›®åˆ†ç»„`* W1D1
       )

```

å½“ä»¥ä¸Šæ¡ä»¶åŸºæœ¬æ»¡è¶³åå°±å¯ä»¥å±•å¼€åæ–¹å·®åˆ†æã€‚ä½œä¸ºå…¶å®æœ¬è´¨æ˜¯çº¿æ€§åˆ†æçš„æ–¹æ³•ï¼Œå…¶å¯ä»¥çº³å…¥çš„åå˜é‡çš„ä¸ªæ•°ä¸åº”è¯¥åªæœ‰ä¸€ä¸ªã€‚ã€‚

one-way ANCOVA
æ„å»ºæ¨¡å‹ã€‚åœ¨Rä¸­éœ€è¦æ³¨æ„*aovå‡½æ•°è¦æ±‚åå˜é‡å†™åœ¨æ•ˆåº”å˜é‡å‰é¢*ã€‚

```{r}
# 
aov_res <- aov(diffW24 ~ W1D1 + `ç ”ç©¶é¡¹ç›®åˆ†ç»„`, # W1D1ä¸ºéœ€è€ƒè™‘çš„åå˜é‡
               data = df)

# type III
car::Anova(aov_res, type =  'III')

# ä¸¤ä¸¤post hoc åˆ†æ
pwc3 <- emmeans_test(
  diffW24 ~ `ç ”ç©¶é¡¹ç›®åˆ†ç»„`,
  covariate = W1D1,
  p.adjust.method = "bonferroni",
  data = df,
  detailed = TRUE
  )
pwc3 # pairwise comparison p-value, å¯ä»¥çœ‹åˆ°å…¶95%CIæ²¡æœ‰ç»è¿‡çŸ«æ­£
get_emmeans(pwc3)

grafify::posthoc_Levelwise(Model = aov_res,
                           Fixed_Factor = c("ç ”ç©¶é¡¹ç›®åˆ†ç»„"),
                           infer = c(TRUE, TRUE)
                           )
```

emmeans è®¡ç®—ä»¥åŠåˆ†æ.
ä»¥ä¸Šæ‰€ç”¨åˆ°çš„å‡½æ•°emmeans_testå’Œposthoc_Levelwiseçš„ç»“æœåœ¨95%CIä¸Šæœ‰äº›è®¸å‡ºå…¥ï¼Œåº”è¯¥å’Œä¸åŒçš„çŸ«æ­£æ–¹æ³•æœ‰å…³ã€‚
ä¸‹é¢å¯¹åæ–¹å·®çš„emmeansåˆ©ç”¨emmeansåŒ…åˆ†æ­¥è¿›è¡Œã€‚å¯ä»¥çœ‹åˆ°emmeans_testçš„ç»“æœæ²¡æœ‰ç»è¿‡På€¼çŸ«æ­£ï¼Œè€Œposthoc_Levelwiseçš„
95%CIç»è¿‡äº†bonferroniçŸ«æ­£ã€‚

```{r}
# æ¯ä¸€ä¸ªå˜é‡åŠå…¶å› å­çš„emmeans
(emm_res <- emmeans::emmeans(aov_res, specs = 'ç ”ç©¶é¡¹ç›®åˆ†ç»„'))

# ä¸¤ä¸¤æ¯”å¯¹çš„contrast
pairs(emm_res, adjust = 'bonferroni', infer = c(TRUE, TRUE))

contrast(emm_res, method = 'pairwise', adjust = 'none', infer = c(T, T))

plot(emm_res, comparisons = TRUE) + theme_bw() +
  labs(x = "Estimated Marginal Mean")

```

### å’Œçº¿æ€§æ¨¡å‹çš„å¯¹æ¯”

å°†ä¸‹é¢çš„æ¨¡å‹å’Œaov_reså¯¹æ¯”ï¼Œå¯ä»¥è§åˆ°äºŒè€…æ˜¯ä¸€è‡´çš„ã€‚

å¯ä»¥æ¨æµ‹åˆ°å¯¹äºç®€å•çº¿æ€§æ¨¡å‹`lm(diffW24 ~ `ç ”ç©¶é¡¹ç›®åˆ†ç»„`, data = df)`å’Œç›´æ¥è®¡ç®—`mean`å€¼å¾—åˆ°çš„ç»“æœåº”è¯¥æ˜¯ä¸€è‡´çš„ã€‚

```{r}
# ?aov æœ¬å°±æ˜¯åˆ©ç”¨çº¿æ€§æ¨¡å‹å¾—åˆ°çš„åˆ†æ

lm_fit <- lm(diffW24 ~ W1D1 + `ç ”ç©¶é¡¹ç›®åˆ†ç»„`,
               data = df)

summary(lm_fit)
car::Anova(lm_fit, type = 'III')
```


### å¤šå› ç´ åæ–¹å·®åˆ†æ

å¤šå› ç´ æ–¹å·®åˆ†æå’Œå¤šå› ç´ åæ–¹å·®åˆ†æç±»åŒã€‚
åœ¨è¿›è¡Œpost hocåˆ†ææ—¶ï¼Œè¦ä¾æ®äº¤äº’æ•ˆåº”æ˜¯å¦æœ‰ç»Ÿè®¡å­¦æ„ä¹‰ï¼Œè¿›è¡Œä¸åŒçš„åˆ†ææ€è·¯ã€‚
å¦‚æœæ²¡æœ‰äº¤äº’æ•ˆåº”åˆ™æŒ‰ç…§ä¸€ä¸ªåˆ†ç»„åˆ†åˆ«æ±‡æŠ¥å¦ä¸€ä¸ªåˆ†ç»„çš„ä¸»æ•ˆåº”ã€‚
å¦‚æœäº¤äº’æ•ˆåº”æœ‰ç»Ÿè®¡å­¦æ„ä¹‰ï¼Œåˆ™å¯ä»¥æŒ‰ç…§dislevelçš„åˆ†ç»„åˆ†åˆ«å¯¹`ç ”ç©¶é¡¹ç›®åˆ†ç»„`è¿›è¡Œoneway ANCOVAçš„åˆ†æ. ç„¶åCompute pairwise comparisons between treatment groups 


```{r}
aov.res2 <- aov(formula = diffW24 ~ W1D1 + `ç ”ç©¶é¡¹ç›®åˆ†ç»„` * dislevel,
                data = df
                )

performance(aov.res2)

car::Anova(aov.res2, type = 'III')
```

ä¸‹é¢è¿›è¡Œpost-hoc åˆ†æ. è€ƒè™‘æ²¡æœ‰äº¤äº’æ•ˆåº”ã€‚
æŒ‰ç…§dislevelåˆ†ç»„ï¼Œåˆ†åˆ«è®¡ç®—`ç ”ç©¶é¡¹ç›®åˆ†ç»„`åˆ†ç»„ä¸­çš„emmeansã€‚

```{r}
pc <- emmeans::emmeans(aov.res2,
                       specs = trt.vs.ctrl ~ `ç ”ç©¶é¡¹ç›®åˆ†ç»„`|dislevel,
                       type = "response",
                       ref = 1,
                       adjust = 'fdr', infer = c(TRUE, TRUE))
pc

(emm_res <- emmeans(aov.res2, specs = c("ç ”ç©¶é¡¹ç›®åˆ†ç»„", 'dislevel')))
contrast(emm_res, method = 'trt.vs.ctrl',
         type = 'response', adjust = 'fdr',by = 'dislevel', infer = c(TRUE, TRUE))
```


#### åŸºäº`modelbased`åŒ…çš„åˆ†æ

`modelbased`åŒ…æä¾›åŒ…æ‹¬ï¼Œä¹Ÿéƒ½æ˜¯å¯¹emmeansçš„åŒ…è£…:

- `estimate_means()`, Estimates the average values at each factor levels
- `estimate_contrasts()`, Estimates and tests contrasts between different factor levels
- `estimate_expectation()`ç­‰æ–¹ä¾¿çš„å‡½æ•°ã€‚

```{r}
# modelçš„emmeans
# æ¯ä¸€ä¸ªå˜é‡çš„factor levelçš„emmeans
# at å‚æ•°è‡ªåŠ¨é€‰æ‹©
# This is typically used when some of the predictors of interest are factors.
emm = modelbased::estimate_means(model = aov_res, 
                           at = 'ç ”ç©¶é¡¹ç›®åˆ†ç»„',
                           transform = 'response',
                           ci = 0.95
                           )
modelbased::estimate_means(model = aov_res, 
                           at = 'ç ”ç©¶é¡¹ç›®åˆ†ç»„=c("å®‰æ…°å‰‚BID", "5mgBID")',
                           transform = 'response',
                           ci = 0.95
                           )
plot(emm)
# standardize(emm)

# contrast
# å¯ä»¥æŒ‡å®šreference contrast(ref)
con <- modelbased::estimate_contrasts(model = aov_res,
                               contrast = "ç ”ç©¶é¡¹ç›®åˆ†ç»„",
                               ci = 0.95,
                               adjust = 'holm', # æ€ä¹ˆæ­¤å‚æ•°æ²¡ç”¨ï¼Ÿä¸€ç›´éƒ½æ˜¯tukeyçš„ç»“æœ
                               method = 'revpairwise'
                               )
# äºŒè€…çš„ç»“æœä¸ä¸€æ ·ï¼Œæ˜¯å› ä¸ºä¸Šé¢å¥½åƒæœ‰bug
contrast(emm_res, method = 'revpairwise', adjust = 'holm', infer = c(T, T))

plot(con, emm)


# is not values on the response variable, but the model's parameters
# marginal effects return averages of coefficients
# åœ¨å¯¹"ç ”ç©¶é¡¹ç›®åˆ†ç»„"è¿™ä¸€åˆ†ç±»å˜é‡çŸ«æ­£åï¼ŒW1D1çš„effect is negative and significant
modelbased::estimate_slopes(model = aov_res)
slopes <- estimate_slopes(aov_res, trend = "W1D1", at = "ç ”ç©¶é¡¹ç›®åˆ†ç»„")

slopes

```


é¢„æµ‹å€¼å’ŒçœŸå®å€¼:

ä»å›¾ä¸­çš„ç»“æœå¯ä»¥çœ‹åˆ°é¢„æµ‹çš„æ•ˆæœä¼¼ä¹ä¸€èˆ¬ã€‚

```{r}
pred_data <- estimate_expectation(aov_res)
head(pred_data)

pred_data$diffW24 <- df$diffW24
pred_data$Predicted_2 <- estimate_expectation(aov.res2)$Predicted

pred_data %>%
  ggplot() +
  geom_line(aes(x = diffW24, y = diffW24), linetype = "dashed") +
  geom_point(aes(x = diffW24, y = Predicted), color = "grey") +
  geom_point(aes(x = diffW24, y = Predicted_2), color = "red") +
  ylab("diffW24 (predicted)") +
  theme_modern()
```

estimate the relationship between the response and the two predictors.

ä¸‰ç»„ç”¨è¯ç»„çš„diffW24éƒ½éšç€W1D1çš„å¢åŠ æœ‰ä¸‹é™çš„è¶‹åŠ¿ï¼Œå¯ä»¥è€ƒè™‘åœ¨å…¥ç»„æ—¶æ‚£è€…screenæœŸçš„æ•°æ®ä¸è¦å¤ªå¤§ã€‚

```{r}
predicted <- estimate_expectation(aov_res, data = "grid")

df %>%
  ggplot(aes(x = W1D1)) +
  geom_point(aes(y = diffW24, color = `ç ”ç©¶é¡¹ç›®åˆ†ç»„`)) +
  geom_ribbon(data = predicted, aes(ymin = CI_low, ymax = CI_high, 
                                    fill = `ç ”ç©¶é¡¹ç›®åˆ†ç»„`), alpha = 0.3) +
  geom_line(data = predicted, aes(y = Predicted, color = `ç ”ç©¶é¡¹ç›®åˆ†ç»„`), size = 1) +
  theme_modern()
```



####  å°†ç»“æœè¾“å‡ºæˆæ‰€éœ€è¦çš„è¡¨æ ¼å¹¶ç»˜åˆ¶æ£®æ—å›¾

*æ£®æ—å›¾*

```{r}
con_p <- pc$contrasts %>% as.data.frame() %>% 
  as_tibble()

plot(pc) + theme_bw()
```

ä¸‹é¢åˆ©ç”¨forestplotåŒ…è¿›è¡Œç»˜åˆ¶ï¼Œä¸è¿‡æ­¤åŒ…çš„ä½¿ç”¨ä¸»è¦æ˜¯è¿˜æ˜¯ä»¥æ•´ç†æˆå…¶æ‰€éœ€è¦çš„æ•°æ®æ ¼å¼ä¸ºä¸»ï¼Œä¼¼ä¹å¯æ“ä½œæ€§å·®ä¸€äº›ã€‚

```{r}
library(forestplot)

ss <- tibble(mean  = 0.531, 
             lower = 0.386,
             upper = 0.731,
             dislevel = "Summary",
             contrast = NA,
             summary = TRUE)

header <- tibble(dislevel = c("Dislevel"),
                 contrast = c("Contrast"),
                 summary = TRUE)

empty_row <- tibble(mean = NA_real_)

con_p <- con_p %>% 
  rename('mean'=estimate,
         'lower' = lower.CL,
         'upper' = upper.CL
         ) %>% select(dislevel, contrast, mean, lower, upper)

header %>% bind_rows(con_p) %>% bind_rows(empty_row) %>% bind_rows(ss) %>% 
  forestplot(
    labeltext = c(dislevel, contrast),
    mean = mean,
    lower = lower,
    upper = upper,
    hrzl_lines = gpar(col = "#444444"),
    is.summary = summary,
    zero = 12,
    grid = structure(c(10), 
                     gp = gpar(lty = 2, col = "#CCCCFF")),
    col = fpColors(box = "royalblue",
                   line = "darkblue",
                   summary = "royalblue"),
    title = 'Forest Plot'
  )
```

forest plot by forester
éº»çƒ¦çš„æ°¸è¿œæ˜¯æ•´ç†æ£®æ—å›¾çš„æ•°æ®ã€‚ä¸çŸ¥èƒ½å¦åŸºäºæŸäº›æ¨¡å‹çš„è¾“å‡ºè‡ªåŠ¨æ•´ç†å¾…åˆ†æçš„æ•°æ®ã€‚

```{r}
# devtools::install_github("rdboyes/forester")
library(forester)


demo_data <- read_csv('./datasets/forest_data.csv')
demo_data$dislevel <- ifelse(is.na(demo_data$contrast),
                          demo_data$dislevel,
                          paste0("  ", demo_data$dislevel))


forester(left_side_data = demo_data[,1:2],
         estimate = demo_data$mean,
         ci_low = demo_data$lower,
         ci_high = demo_data$upper,
         display = FALSE,
         null_line_at = 10,
         font_family = "sans",
         estimate_col_name = "Estimate (95% CI)",
         file_path = here::here("/Users/congliu/Downloads/forester_plot.png"),
         xlim = c(-10, 50),
         ggplot_width = 20,
         arrows = TRUE,
         arrow_labels = c("kx826 Better", "Placebo Better"),
         )
```


Ré‡Œé¢åˆé€‚çš„æ£®æ—å›¾åŒ…è¿˜æ˜¯éœ€è¦ä¸€ä¸ªçš„å‘€ã€‚

```{r}
library(forestploter)


f <- data.frame(aa)

# Add blank column for the forest plot to display CI.
# Adjust the column width with space. 
# è¿™é‡Œç”¨ç©ºç™½è¡Œæ”¾åœ¨ç”»å›¾éƒ¨åˆ†çš„å‰é¢
f$` ` <- paste(rep(" ", 20), collapse = " ")

# Create confidence interval column to display
f$`Diff (95% CI)` <- ifelse(is.na(f$SE), "",
                             sprintf("%.2f (%.2f to %.2f)",
                                     f$estimate, f$lower.CL, f$upper.CL))

# Define theme
tm <- forest_theme(base_size = 10,
                   refline_col = "red",
                   arrow_type = "closed",
                   footnote_col = "blue")

p <- forest(f[,c(1:2, 10:11)],
            est = f$estimate,
            lower = f$lower.CL, 
            upper = f$upper.CL,
            sizes = f$SE,
            ci_column = 3, # å³æ˜¯ç”»å‡ºæ¥çš„CIæ”¾åœ¨ç¬¬å‡ åˆ—ï¼Œè¦å’Œç©ºç™½è¡Œè¿åœ¨ä¸€èµ·
            ref_line = 0,
            arrow_lab = c("Placebo Better", "Treatment Better"),
            # xlim = c(0, 4),
            # ticks_at = c(0.5, 1, 2, 3),
            footnote = "This is the demo data. Please feel free to change\nanything you want.",
            # theme = tm
            )

# Print plot
plot(p)
```


