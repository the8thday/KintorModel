---
title: "sample size calculated in R"
format: html
---


##  sample size calculated in R

> R in action
> 


首先，理解什么是样本量计算，为什么需要样本量计算？样本量计算是假设检验才需要的吗？对于bootstrap、bayes等统计方法需要计算样本量吗？基础研究中经常用到3个Test、3个Control的设计其合理性在哪里？


临床研究中样本量计算的几个示例。

在计算所需样本量时，effect size是最需要考量的指标，毕竟power和significant level易于指定。以ttest为例：

$$Effect Size=(Mean_{A}-Mean_{0})/std.var$$
effect size (cohen's D)本质上是h1假设下和h0假设下的差值除以数据标准差。
Effect size is the magnitude of the effect under the alternate or research hypothesis. The formula for effect size depends on the statistical methodology employed in the hypothesis testing.




### Proportion结局的样本量计算

以文献`Aggressive or Moderate Fluid Resuscitation in Acute Pancreatitis` 为例。

```{r}
library(pwr)
# library(Mediana)
# library(TrialSize)
```


中度重症或重症急性胰腺炎的预期发生率为35%。我们计算得出，在预期10%患者退出的情况下，744例患者的样本量（每组372例患者）将为本试验提供80%的统计学功效，在0.05的双侧显著性水平（α），检测到10个百分点的组间差异（35%与25%之间）。

```{r}
pwr::pwr.2p.test(
  n = NULL,
  h = ES.h(p1 = 0.35, p2 = 0.25),
  sig.level = 0.05,
  alternative = "two.sided",
  power = 0.8)
```
```{r}
# 在有10%失访的情况下

328/0.9
```


### 线性模型

For linear models (such as multiple regression), the pwr.f2.test() function can be used to carry out a power analysis.

where u and v are the numerator and denominator degrees of freedom and f2 is the effect size.

```{r}
pwr.f2.test(u=3, f2=0.0769, sig.level=0.05, power=0.90)
```



### ANOVA

这是`R in action`上的一个示例，很好的说明了在不清楚`effect size`的情况下的一些思路。

```{r}
library(pwr)
es <- seq(.1, .5, .01)                                               
nes <- length(es)
 
samsize <- NULL                                                      
for (i in 1:nes){                                                    
    result <- pwr.anova.test(k=5, f=es[i], sig.level=.05, power=.9)  
    samsize[i] <- ceiling(result$n)                                  
}                                                                    
 
plotdata <- data.frame(es, samsize)

library(ggplot2)
ggplot(plotdata, aes(x=samsize, y=es)) +
  geom_line(color="red", size=1) +
  theme_bw() +
  labs(title="One Way ANOVA (5 groups)",
       subtitle="Power = 0.90,  Alpha = 0.05",
       x="Sample Size (per group)",
       y="Effect Size")
```






### 临床预测模型的样本量估算

> Calculating the sample size required for developing a clinical prediction model。

at least 10 outcome events per variable (EPV) to ensure accuracy.

另外，孙振球教授主编的《医学统计学（第四版）》也给出了一些常用的经验方法，比如：自变量个数的15~20倍（logistic回归分析）、自变量个数的5~10倍（多元线性回归）、自变量个数的15~20倍（Cox回归）。个人认为这些可以看作是10 EPV的扩展。
但是，上述估算方法仅仅是经验做法，只是考虑了最终纳入模型的变量个数（实际上考虑的是系数β的个数），没有考虑到多分类、交互作用、非线性关系等方面的影响，因此，最好是使用每个候选预测因子参数的事件数（EPP）来进行预测。候选参数很重要，因为模型过拟合的程度取决于所考虑的预测参数总数，而不仅仅是最终模型方程中包含的预测参数。



```{r}
library(pmsampsize)
```



```{r}
pmsampsize(type = "b", rsquared = 0.288, 
           parameters = 24, prevalence = 0.174)
```








