---
title: "ANOVA"
format: html
---

## 方差分析

> R in action

方差(variance)指的是，一组数字和其均值间的度量，描述的是一个变量的离散程度，是随机变量与其总体均值或样本均值的离差的平方的期望值。方差是标准差的平方、分布的二阶矩，以及随机变量与其自身的协方差。


方差分析(analysis of variance)的实验设计：
- between group
- within group
- one-way/two-way, et.al...
- balanced/unbalanced
- mixed-model ANOVA: When a factorial design includes both between-groups and within-groups factors

在引入了多个因子变量的情况下，interaction是一定需要设计的吗？three-way，four-way呢？这种交互情况就复杂了。

一些基本概念：
one-way ANOVA: 一个因子自变量，一个因变量
混淆变量(confounding factor)：即影响自变量，也影响因变量
ANCOVA: covariate协变量一般是一个连续变量，在对感兴趣因子进行分析前，adjust for 协变量的影响
MANOVA/MANCOVA: 因变量多于两个


一些公式：
One-way ANOVA: $y ~ A$
One-way ANCOVA with 1 covariate: $y ~ x + A$ 注意顺序
two-way factorial ANOVA: $y ~ A * B$
Randomized block: $y ~ B + A$(B is a blocking factor) 注意顺序

For example, in a two-way ANOVA with unequal numbers of observations in the treatment combinations, the model `y ~ A*B` will not produce the same results as the model `y ~ B*A`. R默认采用TypeI（sequential），还有Type II (hierarchical)、Type III (marginal)，SAS and SPSS employ the Type III approach by default. 如果是均衡设计，3种类型的方差分析没有差别


在本笔记中，重点关注医学统计中的一些用法示例，其中会涉及到医学统计中常用到的概念，不过多也是以上描述的一些不同命名方式罢了。比如随机区组设计资料的方差分析，就是指的two-way ANOVA中的Randomized block。


```{r, include=FALSE}

library(tidyverse)
library(easystats)
library(car)
library(multcomp)
library(statsExpressions)
library(PMCMRplus)
```


### stats 包 aov函数

如上文所述，`aov`函数提供TypeI for partitioning the variance in y among the effects on the right side of this equation.
其是包装的lm函数，不过其的输出更符合常规ANOVA的结构。


#### 完全随机设计资料的方差分析

one-way ANOVA，其假设条件为因变量正态分布、独立、各组间方差相等、线性。

假设检验为：H0 五个分组之间均值相等；H1

```{r}
data(cholesterol, package="multcomp")
```


描述性统计，以及数据检查：
```{r}


```


```{r}
fit1 <- aov(response ~ trt, data=cholesterol)

summary(fit1)

report::report_model(fit1)
```

Type III anova:

```{r}
car::Anova(fit1, type = 'III')
```


模型检验：

```{r}
# 和线性模型一样
plot(fit1) # 输出四幅模型诊断的图片

performance::check_model(fit1)

# 除了满足模型假设外，还需要控制outlier
car::outlierTest(fit1)
```

对于one-way ANOVA其效应值为eta^2^
```{r}
effectsize::effectsize(fit1)
```


```{r}
ggeffects::ggeffect(fit1) |> plot()
```


*post-hoc*分析：

One-way 方差分析的结果表明五个分组间其均值不等，还需要事后检验分析哪二者间不同，一般采用TukeyHSD方法，此方法和emmeans包的paires有何异同呢？

```{r}
(stats::TukeyHSD(fit1)) |> plot()
```

```{r}
emmeans::emmeans(fit1, specs = 'trt') |> pairs()
```


利用`multcomp`包进行多重检验，此处因为是笔记的缘故，故会多个包实现一个目的：

```{r}
tuk <- multcomp::glht(fit, linfct=mcp(trt="Tukey"))

summary(tuk)

labels1 <- cld(tuk, level=.05)$mcletters$Letters
```


#### One-way ANCOVA

在ANOVA的基础上加一个定量的协变量。协变量在`aov`函数中放在公式的前面。不过在`car::Anova`直接包裹时是不用考虑顺序的，因为其所提供的是typeII和typeIII。

```{r}
# gesttime 是连续性变量
# dose 为分类变量，也是我们主要关注的变量
fit2 <- aov(weight ~ gesttime + dose, data=litter)

summary(fit2)
```

模型假设：
线性模型LINE的要求，还要求每个分组中的regression slope保持一致，一般通过引入交互项进行检验，如果交互项有意义， 一般就是不满足条件。如果条件不满足的话，可以采用`sm::ancova`函数进行，其提供非参数方法。

```{r}
aov(weight ~ gesttime*dose, data=litter) |> summary()
```


```{r}
d_p <- broom::augment(fit2)

ggplot(
  data = d_p,
  aes(gesttime, weight)
) +
  geom_point() +
  facet_wrap(~dose, nrow = 1) +
  geom_line(aes(y = .fitted)) +
  labs(title = "ANCOVA for weight by gesttime and dose") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )
```



*post-hoc analysis*

因为有一个协变量，分组均值应该用adjusted后的，既是the group means obtained after partialing out the effects of the covariate. 这里的事后检验通常包括矫正后的均值和contrasts。

```{r}
# 均值
ggeffects::ggeffect(fit2, terms = 'dose')

# same as 
# modelbased::estimate_means(fit2)

litter %>% group_by(dose) %>% summarise(m = mean(weight))
```


contrasts是指在矫正gesttime后，不同dose间weight间的均值差异。`emmeans`提供的便是这种结果。
这和`multcomp`提供的有啥差别呢？

```{r}
# contrsts

modelbased::estimate_contrasts(fit2,
                               method = 'trt.vs.ctrl'
                               )
```


The contrast c(3, -1, -1, -1) specifies a comparison of the first group with the average of the other three. 

```{r}
# Deviation coding?
contrast <- rbind("no drug vs. drug" = c(3, -1, -1, -1))

summary(multcomp::glht(fit2, linfct=mcp(dose=contrast)))
```



#### 随机区组设计资料的方差分析

two-way factorial 分析，两个具有交互作用的分类变量和一个响应变量：

```{r}
fit3 <- aov(len ~ supp*dose, data=ToothGrowth)

summary(fit3)
```

```{r}
gplots::plotmeans(len ~ interaction(dose, supp, sep = ' : '), data=ToothGrowth)
```

Randomized block(随你区组)的实验设计，其数据格式和

```{r}
weight <- c(0.82,0.65,0.51,0.73,0.54,0.23,0.43,0.34,0.28,0.41,0.21,
            0.31,0.68,0.43,0.24)
block <- c(rep(c("1","2","3","4","5"),each=3))
group <- c(rep(c("A","B","C"),5))

data4_4 <- data.frame(weight,block,group)

head(data4_4)
```


```{r}
fit4 <- aov(weight ~ block + group,data = data4_4) #随机区组设计方差分析，注意顺序block位于前面

summary(fit4)
```


拉丁方设计方差分析


```{r}
psize <- c(87,75,81,75,84,66,73,81,87,85,64,79,73,73,74,78,73,77,77,68,69,74,76,73,
           64,64,72,76,70,81,75,77,82,61,82,61)
drug <- c("C","B","E","D","A","F","B","A","D","C","F","E","F","E","B","A","D","C",
          "A","F","C","B","E","D","D","C","F","E","B","A","E","D","A","F","C","B")
col_block <- c(rep(1:6,6))
row_block <- c(rep(1:6,each=6))
mydata <- data.frame(psize,drug,col_block,row_block)
mydata$col_block <- factor(mydata$col_block)
mydata$row_block <- factor(mydata$row_block)
str(mydata)
```

```{r}
fit5 <- aov(psize ~ drug + row_block + col_block, data = mydata)

summary(fit5)
```



#### 两阶段交叉设计资料方差分析


```{r}
contain <- c(760,770,860,855,568,602,780,800,960,958,940,952,635,650,440,450,
             528,530,800,803)
phase <- rep(c("phase_1","phase_2"),10)
type <- c("A","B","B","A","A","B","A","B","B","A","B","A","A","B","B","A",
          "A","B","B","A")
testid <- rep(1:10,each=2)
mydata <- data.frame(testid,phase,type,contain)

str(mydata)
```


```{r}
fit <- aov(contain~phase+type+testid,mydata)

summary(fit)
```


#### Repeated measures ANOVA

对于常见的组间组内设计而言，两个因子间一开始纳入交互项是较为合理的。

重复测量方差分析，不可以有NA值，既是在同一个分组组合中不能有数据缺失。

```{r}
w1b1 <- subset(CO2, Treatment=='chilled')

# Plant 既是Subject
fit6 <- aov(uptake ~ conc*Type + Error(Plant/(conc)), w1b1)

summary(fit6)
```

```{r}
fit7 <- aov(uptake ~ conc*Type + Error(Plant), w1b1) 

summary(fit7)

```


```{r}
CO2 %>%
  group_by(conc, Type) %>%
  summarise(mean_conc = mean(uptake)) %>%
  ggplot(., aes(
    x = conc, y = mean_conc,
    group = Type, color = Type, linetype = Type
  )) +
  geom_point(size = 2) +
  geom_line(size = 1) +
  theme_bw() +
  theme(legend.position = "top") +
  labs(
    x = "Concentration", y = "Mean Uptake",
    title = "Interaction Plot for Plant Type and Concentration"
  )
```

*模型检验：*
除了线性模型的要求外，还需要球形检验。
it assumes that the variances of the differences between any two levels of the within-groups factor are equal.

```{r}

performance::check_sphericity(fit6)
```


*post-hoc*:

```{r}
modelbased::estimate_contrasts(fit6)
```

两两对比并矫正P值：
```{r}

```




#### Multivariate analysis of variance (MANOVA)

one-way MANOVA，同时纳入多个因变量的意思有种显式变量推导隐变量的感觉。三个因变量都属于营养测量这一大的范畴。

```{r}
data(UScereal, package="MASS")
```

```{r}
# 自变量
shelf <- factor(UScereal$shelf)

# 因变量
y <- cbind(UScereal$calories, UScereal$fat, UScereal$sugars)
colnames(y) <- c("calories", "fat", "sugars")
```


```{r}
fit8 <- manova(y ~ shelf)

summary(fit8)
```
*interpret:* The significant F value indicates that 分类变量shelf在营养测量上具有差异。

Because the multivariate test is significant, you can use the summary.aov() function to obtain the univariate one-way ANOVAs.
```{r}
summary.aov(fit8)
```


模型假设：
The two assumptions underlying a one-way MANOVA are multivariate normality and homogeneity of variance-covariance matrices. 

```{r}
# multivariate normal distribution

# homogeneity of variance-covariance matrices
```


*post-hoc*:

```{r}
stats::TukeyHSD(fit8)
```

*Robust MANOVA*
```{r}
rrcov::Wilks.test(y,shelf,method="mcd")

# or

vegan::adonis()
```




