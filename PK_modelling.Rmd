---
title: "pharmacokinetics modelling"
author: "liuc"
date: "1/12/2022"
output: pdf_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## pharmacokinetics modelling by R

> <http://sia.webpopix.org/pharmacokinetics.html>
> <http://sia.webpopix.org/nlme.html>
>
> ç†Ÿæ‚‰nlmixr2åŒ…çš„æ–‡æ¡£
>
> <https://www.pkpd-info.com/PK_introduction.php>
> <http://opensource.nibr.com/xgx/index.html>
> https://cran.r-project.org/web/views/Pharmacokinetics.html 
> https://discuss.go-isop.org/
> https://cran.r-project.org/web/packages/ubiquity/vignettes/NCA.html




Once a drug is administered, we usually describe subsequent processes
within the organism by the pharmacokinetics (PK) process known as ADME:
absorption, distribution, metabolism, excretion.
å…·ä½“çš„å…³äºPKçš„ä¸€äº›æè¿°å¯ä»¥å‚è§ç¬¬å››ä¸ªé“¾æ¥ã€‚

*ä»€ä¹ˆæ˜¯PKçš„æˆ¿å®¤æ¨¡å‹*

å°†äººä½“ç®€åŒ–ä¸ºdepot compartmentã€‚PK compartment models assume that drug
concentration is perfectly homogeneous in each compartment of the body
at all times.

PK models do not describe how a drug is administered. Administered doses
are source terms, i.e., inputs that dynamically modify the state of a
system. This is important to note because it means that the same PK
model can be used for different dose regimens.
å…¸å‹çš„PKæˆ¿å®¤æ¨¡å‹åŒ…æ‹¬ä¸­å¿ƒæˆ¿å®¤ï¼ˆcentral compartmentï¼‰å’Œå¤–å‘¨æˆ¿å®¤ï¼ˆperipheral compartmentsï¼‰ï¼Œä¸­å¿ƒæˆ¿å®¤ä»£è¡¨è¡€æµ†æˆ–è¡€æ¶²å¾ªç¯ç³»ç»Ÿï¼Œè€Œå¤–å‘¨æˆ¿å®¤ä»£è¡¨ç»„ç»‡æˆ–å™¨å®˜ã€‚é€šè¿‡å»ºç«‹å’Œæ±‚è§£ä¸€ç»„å¾®åˆ†æ–¹ç¨‹ï¼ŒPKæˆ¿å®¤æ¨¡å‹å¯ä»¥æè¿°è¯ç‰©åœ¨è¿™äº›æˆ¿å®¤ä¹‹é—´çš„åŠ¨æ€åˆ†å¸ƒå’Œæ¶ˆé™¤è¿‡ç¨‹ã€‚è¿™äº›æ–¹ç¨‹æè¿°äº†è¯ç‰©åœ¨å„ä¸ªæˆ¿å®¤ä¹‹é—´çš„è½¬ç§»é€Ÿç‡ã€è¯ç‰©åœ¨æ¯ä¸ªæˆ¿å®¤ä¸­çš„æµ“åº¦ä»¥åŠè¯ç‰©çš„æ¶ˆé™¤é€Ÿç‡ã€‚ä¸­å¿ƒæˆ¿å®¤ï¼ˆcentral compartmentï¼‰é€šå¸¸ä»£è¡¨è¡€æµ†æˆ–è¡€æ¶²å¾ªç¯ç³»ç»Ÿï¼Œå®ƒæ˜¯è¯ç‰©åœ¨ä½“å†…çš„ä¸»è¦åˆ†å¸ƒåŒºåŸŸã€‚è¯ç‰©åœ¨ä¸­å¿ƒæˆ¿å®¤ä¸­çš„æµ“åº¦å¯ä»¥åæ˜ è¡€æ¶²ä¸­çš„è¯ç‰©æµ“åº¦ã€‚å¤–å‘¨æˆ¿å®¤ï¼ˆperipheral compartmentsï¼‰ä»£è¡¨ä½“å†…çš„ç»„ç»‡æˆ–å™¨å®˜ã€‚è¯ç‰©ä»ä¸­å¿ƒæˆ¿å®¤è¿›å…¥å¤–å‘¨æˆ¿å®¤ï¼Œé€šè¿‡è¡€æ¶²å¾ªç¯åˆ†å¸ƒåˆ°ç»„ç»‡æˆ–å™¨å®˜ä¸­ã€‚å¤–å‘¨æˆ¿å®¤çš„æ•°é‡å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ‰©å±•ï¼Œä»¥æ›´å‡†ç¡®åœ°æè¿°è¯ç‰©åœ¨ä¸åŒç»„ç»‡æˆ–å™¨å®˜ä¹‹é—´çš„åˆ†å¸ƒå’Œè½¬ç§»ã€‚



*ordinary differential equations (ODEs): å¸¸å¾®åˆ†æ–¹ç¨‹*
ODEsåœ¨PKæˆ¿å®¤æ¨¡å‹ä¸­ç”¨äºå»ºç«‹è¯ç‰©åœ¨ä¸­å¿ƒæˆ¿å®¤ï¼ˆé€šå¸¸ä¸ºè¡€æµ†ï¼‰å’Œå¤–å‘¨æˆ¿å®¤ï¼ˆä»£è¡¨ç»„ç»‡æˆ–å™¨å®˜ï¼‰ä¹‹é—´çš„è¯ç‰©è½¬ç§»è¿‡ç¨‹ã€‚é€šè¿‡è¿™äº›æ–¹ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿå’Œé¢„æµ‹è¯ç‰©åœ¨ä½“å†…çš„å¸æ”¶ã€åˆ†å¸ƒå’Œæ¶ˆé™¤è¿‡ç¨‹ï¼Œä»¥åŠè¯ç‰©åœ¨ä¸åŒç»„ç»‡å’Œå™¨å®˜ä¸­çš„æµ“åº¦å˜åŒ–ã€‚

åˆ©ç”¨ODEsï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å’Œæ¨æ–­å‡ºè¯ç‰©åœ¨ç»™å®šå‰‚é‡å’Œç»™è¯æ–¹æ¡ˆä¸‹çš„æµ“åº¦-æ—¶é—´æ›²çº¿ï¼Œä»è€Œäº†è§£è¯ç‰©åœ¨ä½“å†…çš„åŠ¨æ€è¡Œä¸ºã€‚æ­¤å¤–ï¼ŒODEsè¿˜å¯ä»¥ç”¨äºä¼˜åŒ–ç»™è¯æ–¹æ¡ˆã€è¯„ä¼°è¯ç‰©çš„ç–—æ•ˆå’Œæ¯’æ€§ï¼Œä»¥åŠé¢„æµ‹ä¸ªä½“åŒ–çš„è¯ç‰©å‰‚é‡è°ƒæ•´ã€‚


*å¸¸è§çš„ä¸€äº›æŒ‡æ ‡ï¼š*
Vdï¼ˆåˆ†å¸ƒå®¹ç§¯ï¼‰ï¼šè¡¨ç¤ºè¯ç‰©åœ¨ä½“å†…åˆ†å¸ƒçš„å¹¿åº¦ã€‚å®ƒæ˜¯è¯ç‰©æ€»ä½“é‡ä¸è¡€æµ†ä¸­è¯ç‰©æµ“åº¦ä¹‹é—´çš„æ¯”ç‡ã€‚Vdå¯ä»¥åæ˜ è¯ç‰©åœ¨ä½“å†…çš„åˆ†å¸ƒç¨‹åº¦ï¼Œé€šå¸¸ä»¥å‡æˆ–å‡/å…¬æ–¤ä¸ºå•ä½ã€‚
Clï¼ˆæ¸…é™¤ç‡ï¼‰ï¼šè¡¨ç¤ºå•ä½æ—¶é—´å†…ä»ä½“å†…æ¸…é™¤è¯ç‰©çš„é€Ÿç‡ã€‚æ¸…é™¤ç‡å¯ä»¥ç”¨æ¥è¯„ä¼°è¯ç‰©çš„æ¶ˆé™¤é€Ÿåº¦ï¼Œé€šå¸¸ä»¥å‡/å°æ—¶æˆ–å‡/åˆ†é’Ÿä¸ºå•ä½ã€‚
t1/2ï¼ˆåŠè¡°æœŸï¼‰ï¼šè¡¨ç¤ºè¯ç‰©æµ“åº¦å‡å°‘ä¸€åŠæ‰€éœ€çš„æ—¶é—´ã€‚åŠè¡°æœŸæ˜¯æè¿°è¯ç‰©æ¶ˆé™¤é€Ÿåº¦çš„é‡è¦å‚æ•°ï¼Œå¯ä»¥ç”¨æ¥è¯„ä¼°è¯ç‰©åœ¨ä½“å†…çš„åœç•™æ—¶é—´å’Œå‰‚é‡é¢‘ç‡ã€‚
AUCï¼ˆæ›²çº¿ä¸‹é¢ç§¯ï¼‰ï¼šè¡¨ç¤ºè¯ç‰©æµ“åº¦-æ—¶é—´æ›²çº¿ä¸‹çš„é¢ç§¯ï¼Œåæ˜ äº†è¯ç‰©åœ¨ä½“å†…çš„æ€»æ›éœ²ç¨‹åº¦ã€‚AUCå¯ç”¨äºè¯„ä¼°è¯ç‰©çš„å¸æ”¶ã€åˆ†å¸ƒå’Œæ¶ˆé™¤è¿‡ç¨‹ï¼Œå¹¶ä¸è¯ç‰©çš„ç–—æ•ˆå’Œæ¯’æ€§ç›¸å…³ã€‚
Cmaxï¼ˆå³°æµ“åº¦ï¼‰ï¼šè¡¨ç¤ºè¯ç‰©åœ¨ç»™è¯åè¾¾åˆ°çš„æœ€é«˜æµ“åº¦ã€‚Cmaxå¯ä»¥ç”¨æ¥è¯„ä¼°è¯ç‰©çš„å¸æ”¶é€Ÿåº¦å’Œæœ€å¤§æ•ˆåº”ã€‚

k : rate constants (kinetic) -- movement from 'x' to 'y'. (æ¶ˆé™¤é€Ÿç‡å¸¸æ•°ï¼‰ï¼škè¡¨ç¤ºè¯ç‰©ä»ä½“å†…æ¸…é™¤çš„é€Ÿç‡å¸¸æ•°ã€‚å®ƒå†³å®šäº†è¯ç‰©æµ“åº¦ä¸‹é™çš„é€Ÿåº¦ã€‚kçš„å€’æ•°ï¼ˆ1/kï¼‰è¢«ç§°ä¸ºè¯ç‰©çš„æ¶ˆé™¤åŠè¡°æœŸï¼ˆt1/2ï¼‰ã€‚æ¶ˆé™¤é€Ÿç‡å¸¸æ•°ké€šå¸¸ä»¥å°æ—¶çš„å€’æ•°ï¼ˆ1/hï¼‰ä¸ºå•ä½ã€‚
Ka: absorption constant. å¸æ”¶é€Ÿç‡å¸¸æ•°ï¼‰ï¼škaè¡¨ç¤ºè¯ç‰©ä»ç»™è¯éƒ¨ä½å¸æ”¶åˆ°è¡€æ¶²å¾ªç¯çš„é€Ÿç‡å¸¸æ•°ã€‚å®ƒç”¨äºæè¿°è¯ç‰©çš„å¸æ”¶è¿‡ç¨‹ã€‚kaé€šå¸¸ä»¥å°æ—¶çš„å€’æ•°ï¼ˆ1/hï¼‰ä¸ºå•ä½ã€‚
Vc: distribution compartment (central). ï¼ˆä¸­å¿ƒæˆ¿å®¤å®¹ç§¯ï¼‰ï¼šVcè¡¨ç¤ºä¸­å¿ƒæˆ¿å®¤ï¼ˆé€šå¸¸ä¸ºè¡€æµ†ï¼‰çš„å®¹ç§¯ã€‚å®ƒæ˜¯ç”¨æ¥è¡¨ç¤ºè¯ç‰©åœ¨ä¸­å¿ƒæˆ¿å®¤çš„åˆ†å¸ƒèŒƒå›´ã€‚Vcçš„å•ä½é€šå¸¸æ˜¯å‡æˆ–å‡/å…¬æ–¤ã€‚
Q: rate constant between Vc and Vp. ï¼ˆå¤–å‘¨æˆ¿å®¤é—´è½¬ç§»é€Ÿç‡å¸¸æ•°ï¼‰ï¼šQè¡¨ç¤ºä¸åŒå¤–å‘¨æˆ¿å®¤ä¹‹é—´è¯ç‰©è½¬ç§»çš„é€Ÿç‡å¸¸æ•°ã€‚å®ƒç”¨äºæè¿°è¯ç‰©åœ¨ä¸åŒç»„ç»‡æˆ–å™¨å®˜ä¹‹é—´çš„åˆ†å¸ƒå’Œè½¬ç§»ã€‚Qé€šå¸¸ä»¥å‡/å°æ—¶ä¸ºå•ä½ã€‚
Vp: distribution compartment (periph.) 
CL:elimination constant (clearance) Described by differential equations of change in compartment (A) over time (T): dA/dT
At:ï¼ˆæ—¶é—´åˆ°è¾¾æœ€å¤§æµ“åº¦ï¼‰ï¼šè¿™ä¸ªæŒ‡æ ‡è¡¨ç¤ºè¯ç‰©åœ¨ä½“å†…å¸æ”¶è¿‡ç¨‹ä¸­æ‰€éœ€çš„æ—¶é—´ï¼Œé€šå¸¸ä»¥æ—¶é—´å•ä½è¡¨ç¤ºï¼ˆä¾‹å¦‚å°æ—¶ï¼‰ã€‚Atè¡¨ç¤ºä»ç»™è¯å¼€å§‹åˆ°è¯ç‰©åœ¨ä½“å†…è¾¾åˆ°æœ€é«˜æµ“åº¦ï¼ˆCmaxï¼‰æ‰€ç»è¿‡çš„æ—¶é—´ã€‚

Ktpï¼ˆè¡€æµ†åŠè¡°æœŸï¼‰ï¼šè¡€æµ†åŠè¡°æœŸæ˜¯æè¿°è¯ç‰©ä»ä½“å†…æ¶ˆé™¤ä¸€åŠæ‰€éœ€çš„æ—¶é—´ã€‚å®ƒæ˜¯æŒ‡è¯ç‰©æµ“åº¦å‡å°‘åˆ°åˆå§‹æµ“åº¦çš„ä¸€åŠæ‰€éœ€çš„æ—¶é—´ã€‚é€šå¸¸ï¼Œè¡€æµ†åŠè¡°æœŸä»¥æ—¶é—´å•ä½ï¼ˆä¾‹å¦‚å°æ—¶ï¼‰è¡¨ç¤ºã€‚

Kptï¼ˆåˆ†å¸ƒå¸¸æ•°ï¼‰ï¼šKptæ˜¯PKæˆ¿å®¤æ¨¡å‹ä¸­çš„ä¸€ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºè¯ç‰©åˆ†å¸ƒè¿‡ç¨‹çš„é€Ÿåº¦å¸¸æ•°ã€‚å®ƒæè¿°äº†è¯ç‰©ä»è¡€æµ†å‘ç»„ç»‡çš„è½¬ç§»é€Ÿåº¦ã€‚Kptçš„å•ä½é€šå¸¸æ˜¯1/æ—¶é—´ï¼ˆä¾‹å¦‚å°æ—¶çš„å€’æ•°ï¼‰ã€‚

tkaï¼ˆæ—¶é—´åˆ°è¾¾æœ€ä½æµ“åº¦ï¼‰ï¼štkaè¡¨ç¤ºè¯ç‰©åœ¨ä½“å†…å¸æ”¶è¿‡ç¨‹ä¸­æ‰€éœ€çš„æ—¶é—´ï¼Œä»¥è¾¾åˆ°æœ€ä½æµ“åº¦ï¼ˆCminï¼‰ã€‚ç±»ä¼¼äºAtï¼ˆæ—¶é—´åˆ°è¾¾æœ€å¤§æµ“åº¦ï¼‰ï¼Œtkaè¡¨ç¤ºä»ç»™è¯å¼€å§‹åˆ°è¯ç‰©åœ¨ä½“å†…è¾¾åˆ°æœ€ä½æµ“åº¦æ‰€ç»è¿‡çš„æ—¶é—´ã€‚

tclï¼ˆè¡€æµ†æ¶ˆé™¤åŠè¡°æœŸï¼‰ï¼štclæ˜¯æŒ‡è¡€æµ†ä¸­è¯ç‰©æµ“åº¦å‡å°‘åˆ°åˆå§‹æµ“åº¦çš„ä¸€åŠæ‰€éœ€çš„æ—¶é—´ã€‚å®ƒè¡¨ç¤ºè¯ç‰©åœ¨ä½“å†…æ¶ˆé™¤è¿‡ç¨‹çš„é€Ÿåº¦ã€‚tclé€šå¸¸ä»¥æ—¶é—´å•ä½ï¼ˆä¾‹å¦‚å°æ—¶ï¼‰è¡¨ç¤ºã€‚

tvï¼ˆä¸­å¤®åˆ†å¸ƒå®¹ç§¯ï¼‰ï¼štvæ˜¯è¯ç‰©åŠ¨åŠ›å­¦æ¨¡å‹ä¸­çš„ä¸€ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºè¯ç‰©åˆ†å¸ƒåˆ°ä¸­å¤®ç»„ç»‡ï¼ˆé€šå¸¸æ˜¯è¡€æµ†æˆ–ä¸­å¤®è¡€æ± ï¼‰çš„å®¹ç§¯ã€‚å®ƒä»£è¡¨è¯ç‰©åœ¨ä½“å†…çš„åˆ†å¸ƒèŒƒå›´ã€‚tvçš„å•ä½é€šå¸¸æ˜¯å®¹ç§¯å•ä½ï¼ˆä¾‹å¦‚å‡ï¼‰ã€‚



*éçº¿æ€§æ··åˆæ•ˆåº”æ¨¡å‹*

å¯¹äºéçº¿æ€§æ··åˆæ•ˆåº”æ¨¡å‹ï¼ŒThe system will support but not be limited to the following estimation methods: FO, FOI, FOCE, FOCEI, Laplacian, Lindstrom and Bates, MCMC, MCPEM, SAEM, Gaussian quadrature, and nonparametric methodsã€‚



*One-compartment modelï¼ˆä¸€å®¤æ¨¡å‹ï¼‰ï¼š*

åœ¨ä¸€å®¤æ¨¡å‹ä¸­ï¼Œè¯ç‰©è¢«è§†ä¸ºåœ¨ä½“å†…åˆ†å¸ƒå‡åŒ€ã€‚è¿™æ„å‘³ç€è¯ç‰©åœ¨è¡€æ¶²ä¸­çš„æµ“åº¦ä¸ç»„ç»‡ä¸­çš„æµ“åº¦æ˜¯ä¸€è‡´çš„ã€‚è¿™ä¸ªç®€åŒ–æ¨¡å‹å¯¹äºé‚£äº›è¿…é€Ÿåœ¨è¡€æµ†å’Œç»„ç»‡ä¹‹é—´åˆ†å¸ƒçš„è¯ç‰©è¾ƒé€‚ç”¨ã€‚ä½†å¯¹äºé‚£äº›åœ¨ä½“å†…åˆ†å¸ƒä¸å‡åŒ€çš„è¯ç‰©ï¼Œä¸€å®¤æ¨¡å‹å¯èƒ½ä¸èƒ½å‡†ç¡®æè¿°å…¶è¯ä»£åŠ¨åŠ›å­¦ç‰¹å¾ã€‚

*Two-compartment modelï¼ˆä¸¤å®¤æ¨¡å‹ï¼‰ï¼š*

ä¸¤å®¤æ¨¡å‹åŒ…æ‹¬ä¸¤ä¸ªç‹¬ç«‹çš„"å®¤"ï¼šä¸­å¿ƒå®¤ï¼ˆcentral compartmentï¼‰å’Œå¤–å‘¨å®¤ï¼ˆperipheral compartmentï¼‰ã€‚ä¸­å¿ƒå®¤é€šå¸¸åŒ…æ‹¬è¡€æµ†ã€å¿ƒè„ã€è‚è„å’Œè‚¾è„ç­‰é«˜è¡€æµç»„ç»‡ï¼›å¤–å‘¨å®¤é€šå¸¸åŒ…æ‹¬è‚Œè‚‰ã€çš®è‚¤å’Œè„‚è‚ªç­‰è¾ƒä½è¡€æµç»„ç»‡ã€‚åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œè¯ç‰©é¦–å…ˆåœ¨ä¸­å¿ƒå®¤åˆ†å¸ƒï¼Œç„¶åé€šè¿‡è¡€æµè¿›å…¥å¤–å‘¨å®¤ã€‚ä¸¤å®¤æ¨¡å‹è¾ƒå¥½åœ°æè¿°äº†é‚£äº›åœ¨ä½“å†…åˆ†å¸ƒä¸å‡åŒ€çš„è¯ç‰©ã€‚

*Three-compartment modelï¼ˆä¸‰å®¤æ¨¡å‹ï¼‰ï¼š*

ä¸‰å®¤æ¨¡å‹è¿›ä¸€æ­¥ç»†åˆ†äº†è¯ç‰©åœ¨ä½“å†…çš„åˆ†å¸ƒè¿‡ç¨‹ï¼Œå°†å¤–å‘¨å®¤åˆ†ä¸ºä¸¤ä¸ªä¸åŒçš„å®¤ã€‚è¿™ç§æ¨¡å‹é€‚ç”¨äºé‚£äº›åœ¨ä½“å†…å­˜åœ¨å¤šä¸ªä¸åŒåˆ†å¸ƒç›¸çš„è¯ç‰©ã€‚ä¾‹å¦‚ï¼Œè¯ç‰©å¯èƒ½é¦–å…ˆåœ¨ä¸­å¿ƒå®¤åˆ†å¸ƒï¼Œç„¶åè¿…é€Ÿè¿›å…¥ä¸€ä¸ªå¤–å‘¨å®¤ï¼ˆæ¯”å¦‚è¾ƒé«˜è¡€æµçš„ç»„ç»‡ï¼‰ï¼Œå†æ…¢æ…¢è¿›å…¥å¦ä¸€ä¸ªå¤–å‘¨å®¤ï¼ˆæ¯”å¦‚è¾ƒä½è¡€æµçš„ç»„ç»‡ï¼‰ã€‚è¿™ç§æ¨¡å‹å¯ä»¥æ›´ç²¾ç¡®åœ°æè¿°é‚£äº›åœ¨ä½“å†…å…·æœ‰å¤æ‚åˆ†å¸ƒç‰¹å¾çš„è¯ç‰©ã€‚



```{r, include=FALSE}
library(tidyverse)
# library(saemix) # https://saemixr.github.io/
# library(nlmixr) # ä¸»è¦çš„RåŒ…ï¼Œä¸è¿‡å’Œ2çš„ç‰ˆæœ¬ä¸å…¼å®¹ï¼ŒäºŒè€…å…ˆlibraryä¸€ä¸ª

# nlmixr2 is an R package for fitting population pharmacokinetic (PK) and pharmacokinetic-pharmacodynamic (PKPD) models.
library(nlmixr2) # ç›®å‰çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ•´åˆäº†å¤šç§nlmeçš„åŒ…
library(rxode2) # ode-based models
library(nlmixr2data)

library(ggPMX)
library(xpose)

# library('nonmem2R')
library(xgxr) # è¯ºå æä¾›çš„ä¸€ä¸ªæ¢ç´¢æ€§RåŒ…

```


### æ‹ŸåˆPKæ•°æ®çš„æˆ¿å®¤æ¨¡å‹

```{r}
require(pmxTools)
require(nonmem2rx)
require(babelmixr2)
```


#### single-dose å•æ¬¡ç»™è¯

##### fitting a simple one-compartment PK model use `nlmixr2` package.

one-compartmentæŒ‡çš„æ˜¯ï¼ŒIn a one-compartment model, the body is considered as a single well-stirred compartment where the drug distributes instantaneously and uniformly. The model assumes that the drug is rapidly and completely absorbed into the systemic circulation and that the elimination occurs directly from this central compartment.

ä¸‹é¢çš„æ¨¡å‹ä¸­ï¼Œå’Œåœ¨ä½¿ç”¨`saemix`åŒ…æ—¶æ˜¯ä¸€è‡´çš„ï¼ŒåŒ…æ‹¬æ¨¡å‹å’Œèµ·å§‹å€¼ã€‚`nlmixr2`åŒ…çš„è¯­æ³•å’Œiniçš„å‘½åç³»ç»Ÿæ˜¯æ¨¡ä»¿çš„NONMEMè½¯ä»¶ã€‚åœ¨iniä¸­è®¾ç½®å€¼æ—¶ä¸€èˆ¬çš„æ˜¯ä¸€ä¸ªå€¼ï¼Œæˆ–è€…ä¸‰ä¸ªå€¼ï¼ˆc(lower, est, upper)ï¼‰,`~`æ˜¯æ–¹å·®æˆ–ç›¸å…³æ€§ï¼Œ`<-`æ˜¯å‚æ•°èµ‹å€¼,`#`åé¢çš„å†…å®¹æ˜¯
labelçš„å†…å®¹ä¼šåœ¨Parameterå±•ç°ï¼Œä¹Ÿå¯ä»¥ç”¨labelå‡½æ•°ã€‚

å…¶ä¸­ï¼Œmodeléƒ¨åˆ†çš„æ„æ€æ˜¯ï¼šA mathematical model which best describes the data.

`theo_sd`æ˜¯å¸¸è§çš„theophyllineæ•°æ®é›†ï¼Œæ˜¯longitudinal repeated measures
dataï¼Œæ¯ä¸€ä¸ªä¸ªä½“å…¶éšæ—¶é—´æµ‹å¾—çš„è¡€è¯æµ“åº¦åœ¨PK ä¸­éƒ½æ˜¯éçº¿æ€§çš„ã€‚ The form of
the nonlinear model is determined by the pharmacokinetic theory, not
derived from the data.
ä½†æ˜¯ä¾æ®PKç†è®ºæ‰€å¾—åˆ°çš„æ¯ä¸€ä¸ªä¸ªä½“çš„PKå‚æ•°æ˜¯æœ‰å˜åŒ–çš„ï¼Œä¸åŒçš„ï¼Œæ‰€ä»¥è¿˜è¦è€ƒè™‘populationï¼Œå¼•å…¥ä¸ªä½“é—´çš„random
effectã€‚
åœ¨`nlmixr2`ä¸­æ•°æ®çš„åˆ—åæ˜¯æœ‰è¦æ±‚çš„å—ï¼Ÿæ¯•ç«Ÿæ–‡æ¡£çš„ç¤ºä¾‹ä¸­ç›´æ¥å°±è¾“å…¥äº†æ•°æ®åã€‚åœ¨saemixä¸­å°šä¸”éœ€è¦æŒ‡å®šæ•°æ®ã€‚


```{r}
# https://nlmixr2.org/articles/running_nlmixr.html
# æ•°æ®é›†çš„ä»‹ç»æ¥è‡ªå®˜ç½‘
theo_sd
```

> https://nlmixr2.github.io/rxode2/articles/rxode2-datasets.html

Subject Identification Columns
The subject identification column separates subjects for identification of random effects.

ID: A subject identifier that may be an integer, character, or factor.
Observation Columns
Observation columns are used to indicate the dependent variable and how to use or measure it.

DV: A numeric column with the measurement
CENS: A numeric column for indication of censoring, such as below the limit of quantification for an assay.
LIMIT: A numeric column for helping indicate the type of censoring, such as below the limit of quantification for an assay.
MDV: An indicator for missing DV values
CMT: The name or number of the compartment
DVID: The dependent variable identifier
EVID The event identifier
Dosing Columns
AMT: The amount of the dose
CMT: The name or number of the compartment
EVID: The event identifier
ADDL: The number of additional doses
RATE or DUR: The rate or duration of a dose



```{r}
# ç½—åˆ—æ‰€æœ‰çš„Estæ–¹æ³•
nlmixr2est::nlmixr2AllEst()
```


Once the initialization block has been defined, you can define a model in terms of the variables defined in the ini block. You can also mix rxode2() blocks into the model if needed.
```{r}
#  ordinary differential equations (ODEs) model
# é‡‡ç”¨ä¸åŒçš„ç®—æ³•éœ€è¦ä¸åŒçš„æ¨¡å‹å‚æ•°
# åŒæ—¶æ³¨æ„æ–‡æ¡£ä¸­æ‰€ä»‹ç»çš„å‘½åæ ¼å¼çš„é—®é¢˜ï¼Œæ¯”å¦‚rx_ or nlmixr_å¼€å¤´æ˜¯ä¸å…è®¸çš„ï¼Œä¸è¿‡ä¸€èˆ¬ä¹Ÿéƒ½æ˜¯æ¨¡ä»¿NONMEMçš„å‘½å
one.compartment.saem <- function() {
    ini({
        tka <- .5   # Log Ka
        tcl <- -3.2 # Log Cl
        tv <- -1    # Log V
        eta.ka ~ 1 ## BSV Ka
        eta.cl ~ 2
        eta.v ~ 1
        add.err <- 0.1 # residual variability
    })
    model({
        ka <- exp(tka + eta.ka)
        cl <- exp(tcl + eta.cl)
        v <- exp(tv + eta.v)
        d/dt(depot) = -ka * depot
        d/dt(center) = ka * depot - cl / v * center
        cp = center / v 
        cp ~ add(add.err)
    })
}


# Checking model syntax
nlmixr2::nlmixr(one.compartment.saem)
```

fit the model:
fitæ¨¡å‹æœ‰å‡ ç§æ–¹æ³•ï¼Œæ­¤å¤„çš„æ–¹æ³•ï¼Œåœ¨ä¸æä¾›dataå‚æ•°æ—¶ï¼Œä¼šæ‰“å°one.compartment.saemçš„å†…å®¹ã€‚
```{r}
# æ•°æ®é›†ç›¸å…³çš„å˜é‡å•¥ä¹Ÿä¸ç”¨æŒ‡å®šå—ï¼ŸCDISC?
fit <- nlmixr2(one.compartment.saem, 
               data = theo_sd, 
               est="saem" # nlmixr2est::nlmixr2AllEst()
               )
```



åœ¨ç»ˆç«¯æ‰“å°æ›´æ¼‚äº®ï¼š
```{r}
print(fit)
```


base plot:

```{r}
## Standard nlmixr plots
plot(fit)
```
*interpret the result: *




é™¤ä¸Šè¿°é€šè¿‡`base`åŒ…å¾—åˆ°çš„è¯Šæ–­å›¾ä¹‹å¤–ï¼Œè¿˜æä¾›äº†`xpose`åŒ…çš„ä½¿ç”¨ï¼Œ`xpose`åŒ…æ˜¯aims
to reduce the post processing burden and improve diagnostics commonly
associated the development of non-linear mixed effect models. æ£€æŸ¥æ¨¡å‹çš„è¡¨ç°ã€‚

```{r}
library(xpose.nlmixr2)

xpdb <- xpose_data_nlmixr(fit) # æ­¤objectå¯ä»¥ä½¿ç”¨xposeåŒ…çš„å‡½æ•°

xpose::dv_vs_ipred(xpdb)
```


Another option is to use the ggPMX package. 
```{r}
library(ggPMX)
ctr = pmx_nlmixr(fit)
pmx_plot_dv_ipred(ctr)
```


##### ä¸¤æˆ¿å®¤æ¨¡å‹

The â€œtrueâ€ model is two compartmental, with first-order absorption and linear elimination.

```{r}
Bolus_2CPT %>% head(n = 100)
```


###### åˆ©ç”¨`saemix`åŒ…

è¯¦æƒ…è§`saemix`åŒ…çš„å®˜æ–¹æ–‡æ¡£ã€‚

```{r}
saemix.data<-saemixData(name.data=warfa_data,header=TRUE,sep=" ",
  na=NA, name.group=c("id"),name.predictors=c("amount","time"),
  name.response=c("y1"), name.X="time")
```


```{r}
model1cpt<-function(psi,id,xidep) {
  dose<-xidep[,1]
  tim<-xidep[,2]
  ka<-psi[id,1]
  V<-psi[id,2]
  k<-psi[id,3]
  CL<-k*V
  ypred<-dose*ka/(V*(ka-k))*(exp(-k*tim)-exp(-ka*tim))
  return(ypred)
}

saemix.model<-saemixModel(model=model1cpt,description="warfarin",
  type="structural",psi0=matrix(c(1,7,1,0,0,0),ncol=3,byrow=TRUE,
  dimnames=list(NULL, c("ka","V","k"))),transform.par=c(1,1,1),
  omega.init=matrix(c(1,0,0,0,1,0,0,0,1),ncol=3,byrow=TRUE),
  covariance.model=matrix(c(1,0,0,0,1,0,0,0,1),ncol=3,
  byrow=TRUE))
```


###### åˆ©ç”¨`nlmixr2`

```{r}
# ä¸¤æˆ¿å®¤æ¨¡å‹å¯¹åº”çš„èµ·å§‹å€¼
# æ¨¡å‹çš„å¾®åˆ†æ–¹ç¨‹å’Œå‚æ•°

#å®šä¹‰ä¸¤å®¤æ¨¡å‹å…¬å¼

# Two-compartment model with additive residual error:
model.2cpt.ode <- function() {
  ini({
    tka <- log(1.05)
    tcl <- log(0.121)
    tv2 <- log(1.939)
    tv3 <- log(5.65)
    tq <- log(0.282)
    eta.ka ~ 0.1
    eta.cl ~ 0.1
    eta.v2 ~ 0.1
    eta.v3 ~ 0.1
    eta.q ~ 0.1
    add.err <- 75
  })
  model({
    ka <- exp(tka + eta.ka)
    cl <- exp(tcl + eta.cl)
    v2 <- exp(tv2 + eta.v2)
    v3 <- exp(tv3 + eta.v3)
    q <- exp(tq + eta.q)
    d / dt(depot) <- -ka * depot
    d / dt(center) <- ka * depot - cl / v2 * center + q / v3 * periph - q / v2 * center
    d / dt(periph) <- q / v2 * center - q / v3 * periph
    cp <- center / v2
    cp ~ add(add.err)
  })
}

model.2cpt.ode_2 <- function() {
  ini({
    tka <- log(1.05)           # å¸æ”¶é€Ÿç‡å¸¸æ•°çš„å¯¹æ•°å€¼
    tcl <- log(0.121)          # æ¸…é™¤é€Ÿç‡å¸¸æ•°çš„å¯¹æ•°å€¼
    tv2 <- log(1.939)          # ç¬¬äºŒä¸ªç»„ç»‡çš„ä½“ç§¯å¸¸æ•°çš„å¯¹æ•°å€¼
    tv3 <- log(5.65)           # ç¬¬ä¸‰ä¸ªç»„ç»‡çš„ä½“ç§¯å¸¸æ•°çš„å¯¹æ•°å€¼
    tq <- log(0.282)           # ç¬¬ä¸€ä¸ªç»„ç»‡åˆ°ç¬¬äºŒä¸ªç»„ç»‡çš„è½¬ç§»é€Ÿç‡å¸¸æ•°çš„å¯¹æ•°å€¼
    eta.ka ~ 0.1               # å¸æ”¶é€Ÿç‡çš„ä¸ªä½“å·®å¼‚ï¼ˆETAï¼‰çš„æ ‡å‡†å·®
    eta.cl ~ 0.1               # æ¸…é™¤é€Ÿç‡çš„ä¸ªä½“å·®å¼‚ï¼ˆETAï¼‰çš„æ ‡å‡†å·®
    eta.v2 ~ 0.1               # ç¬¬äºŒä¸ªç»„ç»‡çš„ä½“ç§¯çš„ä¸ªä½“å·®å¼‚ï¼ˆETAï¼‰çš„æ ‡å‡†å·®
    eta.v3 ~ 0.1               # ç¬¬ä¸‰ä¸ªç»„ç»‡çš„ä½“ç§¯çš„ä¸ªä½“å·®å¼‚ï¼ˆETAï¼‰çš„æ ‡å‡†å·®
    eta.q ~ 0.1                # ç¬¬ä¸€ä¸ªç»„ç»‡åˆ°ç¬¬äºŒä¸ªç»„ç»‡çš„è½¬ç§»é€Ÿç‡çš„ä¸ªä½“å·®å¼‚ï¼ˆETAï¼‰çš„æ ‡å‡†å·®
    add.err <- 75              # é¢å¤–çš„è¯¯å·®ï¼ˆæ®‹å·®è¯¯å·®ï¼‰å¸¸æ•°å€¼
  })
  model({
    ka <- exp(tka + eta.ka)    # è®¡ç®—å¸æ”¶é€Ÿç‡
    cl <- exp(tcl + eta.cl)    # è®¡ç®—æ¸…é™¤é€Ÿç‡
    v2 <- exp(tv2 + eta.v2)    # è®¡ç®—ç¬¬äºŒä¸ªç»„ç»‡çš„ä½“ç§¯
    v3 <- exp(tv3 + eta.v3)    # è®¡ç®—ç¬¬ä¸‰ä¸ªç»„ç»‡çš„ä½“ç§¯
    q <- exp(tq + eta.q)       # è®¡ç®—ç¬¬ä¸€ä¸ªç»„ç»‡åˆ°ç¬¬äºŒä¸ªç»„ç»‡çš„è½¬ç§»é€Ÿç‡
    d / dt(depot) <- -ka * depot                       # ç¬¬ä¸€ä¸ªç»„ç»‡ï¼ˆdepotï¼‰çš„å˜åŒ–ç‡
    d / dt(center) <- ka * depot - cl / v2 * center + q / v3 * periph - q / v2 * center   # ç¬¬äºŒä¸ªç»„ç»‡ï¼ˆcenterï¼‰çš„å˜åŒ–ç‡
    d / dt(periph) <- q / v2 * center - q / v3 * periph  # ç¬¬ä¸‰ä¸ªç»„ç»‡ï¼ˆperiphï¼‰çš„å˜åŒ–ç‡
    cp <- center / v2          # è®¡ç®—ä¸­å¤®ç»„ç»‡ï¼ˆcenterï¼‰ä¸­çš„è¯ç‰©æµ“åº¦
    cp ~ add(add.err)          # å»ºç«‹ä¸­å¤®ç»„ç»‡ä¸­è¯ç‰©æµ“åº¦ä¸æ®‹å·®è¯¯å·®ä¹‹é—´çš„å…³ç³»
  })
}


# Two-compartment model with proportional residual error:
model.2cptp.ode <- function() {
  ini({
    tka <- log(1.05)
    tcl <- log(0.121)
    tv2 <- log(1.939)
    tv3 <- log(5.65)
    tq <- log(0.282)
    eta.ka ~ 0.1
    eta.cl ~ 0.1
    eta.v2 ~ 0.1
    eta.v3 ~ 0.1
    eta.q ~ 0.1
    prop.err <- 0.075
  })
  model({
    ka <- exp(tka + eta.ka)
    cl <- exp(tcl + eta.cl)
    v2 <- exp(tv2 + eta.v2)
    v3 <- exp(tv3 + eta.v3)
    q <- exp(tq + eta.q)
    d / dt(depot) <- -ka * depot
    d / dt(center) <- ka * depot - cl / v2 * center + q / v3 * periph - q / v2 * center
    d / dt(periph) <- q / v2 * center - q / v3 * periph
    cp <- center / v2
    cp ~ prop(prop.err)
  })
}


# Two-compartment model with proportional residual error and weight on CL:
model.2cpt.ode.wtcl <- function() {
  ini({
    tka <- log(1.14)
    tcl <- log(0.0190)
    tv2 <- log(2.12)
    tv3 <- log(20.4)
    tq <- log(0.383)
    wteff <- 0.35
    eta.ka ~ 1
    eta.cl ~ 1
    eta.v2 ~ 1
    eta.v3 ~ 1
    eta.q ~ 1
    prop.err <- 0.075
  })
  model({
    ka <- exp(tka + eta.ka)
    cl <- exp(tcl + wteff * lnWT + eta.cl)
    v2 <- exp(tv2 + eta.v2)
    v3 <- exp(tv3 + eta.v3)
    q <- exp(tq + eta.q)
    d / dt(depot) <- -ka * depot
    d / dt(center) <- ka * depot - cl / v2 * center + q / v3 * periph - q / v2 * center
    d / dt(periph) <- q / v2 * center - q / v3 * periph
    cp <- center / v2
    cp ~ prop(prop.err)
  })
}


# Two-compartment model with proportional residual error and sex on ğ‘‰ğ‘‰2:
model.2cpt.ode.sexv2 <- function() {
  ini({
    tka <- log(1.14)
    tcl <- log(0.0190)
    tv2 <- log(2.12)
    tv3 <- log(20.4)
    tq <- log(0.383)
    sexeff <- -0.2
    eta.ka ~ 1
    eta.cl ~ 1
    eta.v2 ~ 1
    eta.v3 ~ 1
    eta.q ~ 1
    prop.err <- 0.075
  })
  model({
    ka <- exp(tka + eta.ka)
    cl <- exp(tcl + eta.cl)
    v2 <- exp(tv2 + sexeff * (SEX) + eta.v2)
    v3 <- exp(tv3 + eta.v3)
    q <- exp(tq + eta.q)
    d / dt(depot) <- -ka * depot
    d / dt(center) <- ka * depot - cl / v2 * center + q / v3 * periph - q / v2 * center
    d / dt(periph) <- q / v2 * center - q / v3 * periph
    cp <- center / v2
    cp ~ prop(prop.err)
  })
}
```


```{r}
# Checking model syntax
nlmixr2::nlmixr(model.2cpt.ode)
```

æ¨¡å‹çš„æ‹Ÿåˆè¿‡ç¨‹éå¸¸è€—æ—¶ï¼Œè¦æ³¨æ„æ•°æ®çš„å¤§å°ï¼Œä¸çŸ¥èƒ½å¦å¤šçº¿ç¨‹è¿è¡Œã€‚
å¯¹äºæ­¤æ•°æ®é›†ï¼Œåœ¨æˆ‘çš„Macä¸Šè·‘äº†å¾—æœ‰ä¸€ä¸ªå¤šå°æ—¶ã€‚
```{r}
# fit.2cpt.ode.saem <- nlmixr2(object = model.2cpt.ode,
#                              data = Bolus_2CPT,
#                              est = 'saem'
#                              )

# write_rds(fit.2cpt.ode.saem, './datasets/fit.2cpt.ode.saem.rds')

readRDS('./datasets/fit.2cpt.ode.saem.rds')
```


```{r}
# è¿è¡Œä¹Ÿå¾ˆä¹…
AIC(fit.2cpt.ode.saem)
```


åˆ©ç”¨`xpose`åŒ…åšæ£€æŸ¥ï¼š
```{r}
# require(xpose.nlmixr2)

xpdb <- xpose.nlmixr2::xpose_data_nlmixr2(fit.2cpt.ode.saem)

xpdb
```

```{r}
# ä¼¼ä¹æœ‰ç‚¹å°é—®é¢˜
summary(xpdb, problem = 1)
```

æ•°æ®æ‹Ÿåˆçš„å¾ˆå·®ï¼Œå¯¹äºè¿™ç§æ‹Ÿåˆå¾ˆå·®çš„æƒ…å†µè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ
```{r}
dv_vs_ipred(xpdb)
```



##### three compartment model


```{r}
# Three-compartment model with proportional residual error:

model.3cpt.ode <- function() {
 ini({
 tka <- log(1.42)
 tcl <- log(0.044)
 tv2 <- log(2)
 tv3 <- log(10)
 tv4 <- log(10)
 tq2 <- log(0.5)
 tq3 <- log(0.5)
 eta.ka ~ 0.1
 eta.cl ~ 0.1
 eta.v2 ~ 0.1
 eta.v3 ~ 0.1
 eta.v4 ~ 0.1
 eta.q2 ~ 0.1
 eta.q3 ~ 0.1
 prop.err <- 0.075
 })
 model({
 ka <- exp(tka + eta.ka)
 cl <- exp(tcl + eta.cl)
 v2 <- exp(tv2 + eta.v2)
 v3 <- exp(tv3 + eta.v3)
 v4 <- exp(tv4 + eta.v4)
 q2 <- exp(tq2 + eta.q2)
 q3 <- exp(tq3 + eta.q3)
 d/dt(depot) = -ka * depot
 d/dt(center) = ka * depot - cl / v2 * center + q2/v3 * periph1 - q2/v2 * center + q3/v4 *
periph2 - q3/v2 * center
 d/dt(periph1) = q2/v2 * center - q2/v3 * periph1
 d/dt(periph2) = q3/v2 * center - q3/v4 * periph2
 cp = center / v2
 cp ~ prop(prop.err)
 })
}


# å®šä¹‰æ¨¡å‹
model.3cpt.ode <- function() {

  # åˆå§‹å€¼
  ini({
    # å¸æ”¶é€Ÿç‡å¸¸æ•°çš„å¯¹æ•°å€¼
    tka <- log(1.42)  
    # æ¸…é™¤ç‡å¸¸æ•°çš„å¯¹æ•°å€¼ 
    tcl <- log(0.044)   
    # ä¸­å¤®å®¤ä½“ç§¯çš„å¯¹æ•°å€¼
    tv2 <- log(2) 
    # å¤–å‘¨å®¤1ä½“ç§¯çš„å¯¹æ•°å€¼ 
    tv3 <- log(10)  
    # å¤–å‘¨å®¤2ä½“ç§¯çš„å¯¹æ•°å€¼
    tv4 <- log(10) 
    # ä»ä¸­å¤®å®¤åˆ°å¤–å‘¨å®¤1çš„é—´è´¨æ¸…é™¤é€Ÿç‡å¸¸æ•°çš„å¯¹æ•°å€¼
    tq2 <- log(0.5) 
    # ä»ä¸­å¤®å®¤åˆ°å¤–å‘¨å®¤2çš„é—´è´¨æ¸…é™¤é€Ÿç‡å¸¸æ•°çš„å¯¹æ•°å€¼
    tq3 <- log(0.5)
    # å¸æ”¶é€Ÿç‡çš„éšæœºæ•ˆåº”æ ‡å‡†å·®
    eta.ka ~ 0.1 
    # æ¸…é™¤ç‡çš„éšæœºæ•ˆåº”æ ‡å‡†å·® 
    eta.cl ~ 0.1    
    # ä¸­å¤®å®¤ä½“ç§¯çš„éšæœºæ•ˆåº”æ ‡å‡†å·®
    eta.v2 ~ 0.1
    # å¤–å‘¨å®¤1ä½“ç§¯çš„éšæœºæ•ˆåº”æ ‡å‡†å·®
    eta.v3 ~ 0.1  
    # å¤–å‘¨å®¤2ä½“ç§¯çš„éšæœºæ•ˆåº”æ ‡å‡†å·®
    eta.v4 ~ 0.1
    # ä»ä¸­å¤®å®¤åˆ°å¤–å‘¨å®¤1çš„é—´è´¨æ¸…é™¤é€Ÿç‡éšæœºæ•ˆåº”æ ‡å‡†å·®
    eta.q2 ~ 0.1
    # ä»ä¸­å¤®å®¤åˆ°å¤–å‘¨å®¤2çš„é—´è´¨æ¸…é™¤é€Ÿç‡éšæœºæ•ˆåº”æ ‡å‡†å·®
    eta.q3 ~ 0.1
    # å½’ä¸€åŒ–æ®‹å·®çš„æ ‡å‡†å·®
    prop.err <- 0.075
  })

  # æ¨¡å‹æ–¹ç¨‹ 
  model({
    # å¸æ”¶é€Ÿç‡
    ka <- exp(tka + eta.ka)
    # æ¸…é™¤ç‡
    cl <- exp(tcl + eta.cl) 
    # ä¸­å¤®å®¤ä½“ç§¯
    v2 <- exp(tv2 + eta.v2)
    # å¤–å‘¨å®¤1ä½“ç§¯
    v3 <- exp(tv3 + eta.v3)
    # å¤–å‘¨å®¤2ä½“ç§¯
    v4 <- exp(tv4 + eta.v4)
    # ä»ä¸­å¤®å®¤åˆ°å¤–å‘¨å®¤1çš„é—´è´¨æ¸…é™¤é€Ÿç‡ 
    q2 <- exp(tq2 + eta.q2) 
    # ä»ä¸­å¤®å®¤åˆ°å¤–å‘¨å®¤2çš„é—´è´¨æ¸…é™¤é€Ÿç‡
    q3 <- exp(tq3 + eta.q3)

    # é‡Šæ”¾éƒ¨ä½é‡çš„å¾®åˆ†æ–¹ç¨‹
    d/dt(depot) = -ka * depot

    # ä¸­å¤®å®¤é‡çš„å¾®åˆ†æ–¹ç¨‹
    d/dt(center) = ka * depot - cl / v2 * center +  
                   q2/v3 * periph1 - q2/v2 * center + 
                   q3/v4 * periph2 - q3/v2 * center

    # å¤–å‘¨å®¤1é‡çš„å¾®åˆ†æ–¹ç¨‹
    d/dt(periph1) = q2/v2 * center - q2/v3 * periph1

    # å¤–å‘¨å®¤2é‡çš„å¾®åˆ†æ–¹ç¨‹ 
    d/dt(periph2) = q3/v2 * center - q3/v4 * periph2

    # ä¸­å¤®å®¤æµ“åº¦
    cp = center / v2

    # æµ“åº¦çš„è¯¯å·®æ¨¡å‹
    cp ~ prop(prop.err)
  })

}

```


#### multi-dose å¤šæ¬¡ç»™è¯

```{r}
theo_md
```




### use PKNCA åŒ…


*NCAçš„å®éªŒè®¾è®¡è¦ç‚¹ï¼š*
æ­¤åŒ…ä¸»è¦æ˜¯æä¾›non-compartmental analysis (NCA) PKè®¡ç®—æ–¹æ³•, NCA is used
as method of description of PK with minimal assumptions of the rates of
distribution of the drug through the body. NCA is typically used to
describe the PK of a drug in clinical studies with many samples per
subject on the same and sequential days.

complete sampling and sparse sampling designså…·ä½“æŒ‡çš„æ˜¯ï¼Œ

ä»¥æˆ‘è¿™ä¸¤å¤©æŸ¥èµ„æ–™çš„æƒ…å†µæ¥çœ‹ï¼ŒNCAå’Œä¸Šæ–‡çš„modelingæ–¹æ³•è¿˜æ˜¯ä¸ä¸€æ ·çš„ã€‚é¡¾åæ€ä¹‰ï¼Œä¸€ä¸ªæŠŠäººä½“ç†è§£ä¸ºcompartmentï¼Œä¸€ä¸ªæ²¡æœ‰ã€‚

PKNCAéœ€è¦ä¸¤ä¸ªæ•°æ®é›†ï¼Œåˆ†åˆ«æ˜¯æµ“åº¦æ•°æ®é›†å’Œdoseæ•°æ®é›†ï¼Œå¯¹äºæ¯ä¸ªæ•°æ®é›†ä¸­çš„åˆ†ç±»å˜é‡ï¼Œå…¶çš„è¯­æ³•ä¸ºï¼šconcentration, dose, and time must all be numeric.


*NCAçš„ä¸€äº›èµ„æ–™æ”¶é›†ï¼š*

åªè¦è¯ç‰©ç¬¦åˆçº¿æ€§è¯ç‰©åŠ¨åŠ›å­¦ï¼Œä¸ç®¡å®ƒå±äºä»€ä¹ˆæ ·çš„éš”å®¤æ¨¡å‹ï¼Œéƒ½èƒ½ä½¿ç”¨éæˆ¿å®¤æ–¹æ³•ã€‚éæˆ¿å®¤æ¨¡å‹æ˜¯ä¸´åºŠè®¡ç®—PKå‚æ•°çš„ä¸»è¦æ–¹æ³•ã€‚
WinNonlinä¸­éæˆ¿å®¤æ¨¡å‹åˆ†æï¼Œä»¥æ¦‚ç‡è®ºå’Œæ•°ç†ç»Ÿè®¡å­¦ä¸­çš„ç»Ÿè®¡çŸ©æ–¹æ³•ä¸ºç†è®ºåŸºç¡€ï¼Œå¯¹æ•°æ®è¿›è¡Œè§£æï¼Œä¸»è¦åŒ…æ‹¬é›¶é˜¶çŸ©å’Œä¸€é˜¶çŸ©ã€‚

å…¶ä¸­ä¸ä¾èµ–æœ«ç«¯æ¶ˆé™¤é€Ÿç‡Î»zçš„å‚æ•°æœ‰è¯å³°æµ“åº¦ï¼ˆCmaxï¼‰ï¼Œè¾¾å³°æ—¶é—´ï¼ˆTmaxï¼‰ï¼Œæœ€åä¸€ä¸ªå¯å®šé‡ç‚¹æ‰€å¯¹åº”çš„æ—¶é—´ç‚¹ï¼ˆTlastï¼‰å’Œè¯ç‰©æµ“åº¦ï¼ˆClastï¼‰ï¼Œè¿™äº›å‚æ•°ä¸ä¾èµ–äºè®¡ç®—ï¼Œè€Œæ˜¯ç›´æ¥ç”±è§‚æµ‹å€¼å¾—å‡ºã€‚è¿˜æœ‰ä»0æ—¶åˆ»åˆ°æœ€åä¸€ä¸ªå¯å®šé‡ç‚¹æ‰€å¯¹åº”çš„æ›²çº¿ä¸‹é¢ç§¯ï¼ˆAUClastï¼‰ï¼Œä¸€é˜¶çŸ©å¹³å‡é©»ç•™æ—¶é—´ï¼ˆMRTï¼‰ï¼Œååº”äº†è¯ç‰©åœ¨ä½“å†…çš„å¹³å‡åœç•™æ—¶é—´ã€‚


*ä¸€äº›æ¦‚å¿µçš„ç†æ¸…ï¼š*
AUClast(Area Under the Curve)ï¼šAUClastæ˜¯è¯ç‰©ç”Ÿç‰©åˆ©ç”¨åº¦æè¿°æŒ‡æ ‡ï¼Œä¹Ÿå°±æ˜¯é€ç‚¹æ³•è®¡ç®—å¾—åˆ°çš„ä»ç»™è¯å¼€å§‹åˆ°æœ€åæµ‹é‡å¾—åˆ°æµ‹å®šæµ“åº¦ï¼ˆClastï¼‰çš„è¯ç‰©æš´éœ²ç¨‹åº¦ã€‚å³è¯ç‰©åœ¨ä½“å†…çš„æš´éœ²ç¨‹åº¦ï¼Œåæ˜ è¯ç‰©çš„å¸æ”¶ç¨‹åº¦ã€‚AUClastæ˜¯æŒ‡è¯ç‰©åœ¨æœ€åä¸€ä¸ªå¯æµ‹é‡æ—¶é—´ç‚¹ï¼ˆé€šå¸¸ä¸ºæœ€åä¸€ä¸ªé‡‡æ ·æ—¶é—´ç‚¹ï¼‰å‰çš„æ›²çº¿ä¸‹é¢ç§¯ã€‚å®ƒåæ˜ äº†è¯ç‰©åœ¨ä½“å†…çš„æ€»ä½“æ›éœ²ç¨‹åº¦ï¼Œå³è¯ç‰©åœ¨ä½“å†…çš„æµ“åº¦éšæ—¶é—´çš„ç§¯ç´¯æƒ…å†µã€‚AUClastå¯ä»¥é€šè¿‡è®¡ç®—è¯ç‰©æµ“åº¦ä¸æ—¶é—´çš„æ›²çº¿ä¸‹çš„é¢ç§¯æ¥è·å¾—ã€‚

Cmax(Maximum Concentration)ï¼šè¯ç‰©å¸æ”¶åï¼Œä½“å†…æµ“åº¦è¾¾åˆ°æœ€å¤§å€¼å³ä¸ºCmaxã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒCmaxè¶Šå¤§ï¼Œè¯´æ˜è¯ç‰©å¸æ”¶è¶Šå¿«è¶Šå…¨ã€‚å®ƒæ˜¯ä¸€ä¸ªç”¨æ¥æç»˜ç»™è¯åè¯ç‰©æµ“åº¦-æ—¶é—´æ›²çº¿ï¼ˆconcentration-time curveï¼‰çš„é‡è¦å‚æ•°ã€‚ Cmaxé€šå¸¸ç”¨æ¥è¯„ä¼°è¯ç‰©çš„å¸æ”¶é€Ÿåº¦å’Œç¨‹åº¦ï¼Œå¯¹äºè¯ç‰©çš„ç–—æ•ˆå’Œå®‰å…¨æ€§å…·æœ‰é‡è¦æ„ä¹‰ã€‚*Cmaxä¼¼ä¹å°±æ˜¯æ—¶é—´æ¢¯åº¦ä¸­æœ€å¤§çš„é‚£ä¸ªå€¼ï¼Œä¸”æ¥è‡ªè§‚æµ‹æ•°æ®æœ¬èº«ï¼Œä¸æ˜¯æ¨¡å‹æ‹Ÿåˆè®¡ç®—å¾—æ¥çš„ã€‚*

Clastï¼šClastæ˜¯æŒ‡åœ¨ç»™è¯åçš„æœ€åæµ‹å®šæ—¶åˆ»æ‰€æµ‹å¾—çš„è¯ç‰©æµ“åº¦ï¼Œä¹Ÿå°±æ˜¯è¯ç‰©åœ¨ä½“å†…å¸æ”¶è¿‡ç¨‹çš„æœ€åæµ‹å®šç‚¹çš„è¡€è¯æµ“åº¦ã€‚clasté€šå¸¸ç”¨äºè¯„ä¼°è¯ç‰©åœ¨ä½“å†…çš„æ¶ˆé™¤é€Ÿåº¦å’ŒåŠè¡°æœŸã€‚*å…¶ä¹Ÿæ˜¯ç›´æ¥æå–çš„raw dataä¸­çš„æ•°æ®*

Tmax(Time to Maximum Concentration)ï¼šè¿™æ˜¯è¯ç‰©è¾¾åˆ°æœ€å¤§æµ“åº¦çš„æ—¶é—´ã€‚è¿™é€šå¸¸æ˜¯ä¸€ä¸ªåæ˜ è¯ç‰©å¸æ”¶é€Ÿåº¦çš„é‡è¦æŒ‡æ ‡ã€‚*æ¥è‡ªæ•°æ®æœ¬èº«*

AUC0-âˆï¼šè¿™æ˜¯ä»ç»™è¯å¼€å§‹åˆ°æ— ç©·è¿œçš„é¢„æµ‹è¯ç‰©å…¨èº«æš´éœ²ç¨‹åº¦ã€‚å¹³å‡æ¥è¯´ï¼ŒAUC0-âˆç›¸æ¯”AUClastèƒ½æ›´å¥½åœ°åæ˜ è¯ç‰©çš„å…¨éƒ¨ä½“å†…æš´éœ²ç¨‹åº¦ã€‚å®ƒåæ˜ äº†è¯ç‰©åœ¨ä½“å†…çš„æ€»ä½“æ›éœ²ç¨‹åº¦ï¼ŒåŒ…æ‹¬è¯ç‰©çš„å¸æ”¶ã€åˆ†å¸ƒã€ä»£è°¢å’Œæ’æ³„è¿‡ç¨‹ã€‚

T1/2(Half-life) ï¼šè¿™æ˜¯è¯ç‰©åŠè¡°æœŸï¼Œè¡¨ç¤ºè¯ç‰©æµ“åº¦å‡åŠæ‰€éœ€çš„æ—¶é—´ã€‚è¿™ä¸ªæ•°å­—åæ˜ äº†è¯ç‰©ä»ä½“å†…æ¶ˆé™¤çš„é€Ÿåº¦ã€‚

CL(Clearance)ï¼šæ¸…é™¤ç‡ï¼Œè¡¡é‡ä½“å†…æ¸…é™¤è¯ç‰©çš„èƒ½åŠ›ã€‚å®ƒå¯ä»¥åæ˜ è¯ç‰©çš„ä»£è°¢å’Œæ’æ³„æƒ…å†µã€‚æ¸…é™¤ç‡è¶Šé«˜ï¼Œè¯ç‰©åœ¨ä½“å†…çš„åœç•™æ—¶é—´è¶ŠçŸ­ã€‚
$CL=Dose/AUC$

Vd(volume of distribution)ï¼šåˆ†å¸ƒå®¹ç§¯ï¼Œåæ˜ è¯ç‰©åœ¨ä½“å†…åˆ†å¸ƒçš„å¹¿åº¦ã€‚

MRT(Mean residence time): $MRT=AUMC/AUC$, è¡¨ç¤ºè¯ç‰©åœ¨ä½“å†…å¹³å‡åœç•™çš„æ—¶é—´

Vss(Steady state volume of distribution): $Vss = MRT Ã— CL$ , ç¨³æ€åˆ†å¸ƒå®¹ç§¯ï¼‰æ˜¯ä¸€ä¸ªç”¨äºæè¿°è¯ç‰©åœ¨ä½“å†…åˆ†å¸ƒçš„å‚æ•°ï¼Œé€šå¸¸ç”¨ç¬¦å·Vssè¡¨ç¤ºã€‚å®ƒè¡¨ç¤ºåœ¨ç¨³æ€æ¡ä»¶ä¸‹ï¼Œä½¿è¡€æµ†ä¸­çš„è¯ç‰©æµ“åº¦è¾¾åˆ°å¹³è¡¡æ‰€éœ€çš„è¯ç‰©æ€»é‡ä¸è¡€æµ†ä¸­çš„è¯ç‰©æµ“åº¦ä¹‹é—´çš„å…³ç³»ã€‚

"lambda" é€šå¸¸ç”¨äºè¡¨ç¤ºè¯ç‰©çš„æ¶ˆé™¤é€Ÿç‡å¸¸æ•°ï¼ˆelimination rate constantï¼‰ã€‚æ¶ˆé™¤é€Ÿç‡å¸¸æ•°æ˜¯è¡¡é‡è¯ç‰©ä»ä½“å†…æ¸…é™¤çš„é€Ÿåº¦çš„æŒ‡æ ‡ï¼Œå®ƒè¡¨ç¤ºåœ¨å•ä½æ—¶é—´å†…è¯ç‰©æµ“åº¦å‡å°‘çš„æ¯”ä¾‹ã€‚

"tlag" åœ¨è¯ç‰©è¯ä»£åŠ¨åŠ›å­¦ä¸­æ˜¯æŒ‡è¯ç‰©åœ¨ç»™è¯åè¿›å…¥å¾ªç¯ç³»ç»Ÿçš„å»¶è¿Ÿæ—¶é—´ï¼ˆlagtimeï¼‰ã€‚å®ƒè¡¨ç¤ºä»ç»™è¯åˆ°è¯ç‰©å¼€å§‹å‡ºç°åœ¨è¡€æ¶²ä¸­æµ‹é‡åˆ°çš„æµ“åº¦çš„æ—¶é—´é—´éš”ã€‚

AUMCinfï¼ˆArea Under the Moment Curve at Infinityï¼‰æ˜¯æŒ‡è¯ç‰©çš„æ— é™æ—¶åˆ»çŸ©æ—¶åˆ»æ›²çº¿ä¸‹çš„é¢ç§¯ã€‚ å®ƒæ˜¯PKï¼ˆPharmacokineticsï¼Œè¯ç‰©è¯ä»£åŠ¨åŠ›å­¦ï¼‰ä¸­çš„ä¸€ä¸ªè¡¡é‡å‚æ•°ï¼Œç”¨äºæè¿°è¯ç‰©åœ¨ä½“å†…çš„æ€»ä½“æš´éœ²ç¨‹åº¦å’Œåˆ†å¸ƒã€‚AUMCinfæ˜¯é€šè¿‡è®¡ç®—è¯ç‰©æµ“åº¦-æ—¶é—´æ›²çº¿çš„çŸ©æ—¶åˆ»æ›²çº¿ä¸‹çš„é¢ç§¯æ¥è·å¾—çš„ã€‚çŸ©æ—¶åˆ»æ›²çº¿æ˜¯å°†æ—¶é—´çš„å„ä¸ªæ¬¡å¹‚ä¹˜ä»¥å¯¹åº”æ—¶é—´ç‚¹ä¸Šçš„è¯ç‰©æµ“åº¦æ‰€å¾—åˆ°çš„æ›²çº¿ã€‚AUMCinfé€šå¸¸ä¸AUCinfï¼ˆArea Under the Concentration Curve at Infinityï¼Œæ— é™æ—¶åˆ»æµ“åº¦æ›²çº¿ä¸‹çš„é¢ç§¯ï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œä»¥æä¾›æ›´å…¨é¢çš„è¯ç‰©æš´éœ²å’Œè¯ä»£åŠ¨åŠ›å­¦ä¿¡æ¯ã€‚

Span ratioï¼ˆè·¨åº¦æ¯”ï¼‰æ˜¯åœ¨éç»„åˆ†åˆ†æï¼ˆNCAï¼‰ä¸­ç”¨äºè¯„ä¼°è¯ç‰©çš„ä½“å†…åˆ†å¸ƒç‰¹æ€§çš„æŒ‡æ ‡ä¹‹ä¸€ã€‚å®ƒæ˜¯é€šè¿‡è®¡ç®—è¯ç‰©åœ¨è¡€æµ†å’Œä½“æ¶²ï¼ˆå¦‚ç»„ç»‡æˆ–å°¿æ¶²ï¼‰ä¸­çš„æµ“åº¦ä¹‹é—´çš„æ¯”å€¼æ¥å¾—åˆ°çš„ã€‚è·¨åº¦æ¯”çš„è®¡ç®—é€šå¸¸é‡‡ç”¨AUCï¼ˆArea Under the Curveï¼Œæ›²çº¿ä¸‹é¢ç§¯ï¼‰ä½œä¸ºè¡€æµ†å’Œä½“æ¶²æµ“åº¦æ›²çº¿çš„åº¦é‡ï¼Œå¹¶åˆ†åˆ«è®¡ç®—è¡€æµ†å’Œä½“æ¶²çš„AUCå€¼ã€‚ç„¶åï¼Œé€šè¿‡è®¡ç®—ä½“æ¶²AUCä¸è¡€æµ†AUCçš„æ¯”å€¼ï¼Œå¾—åˆ°è·¨åº¦æ¯”ã€‚è·¨åº¦æ¯”å¤§äº1è¡¨ç¤ºè¯ç‰©åœ¨ä½“æ¶²ä¸­çš„æµ“åº¦é«˜äºè¡€æµ†ä¸­çš„æµ“åº¦ï¼Œè¡¨æ˜è¯ç‰©åœ¨ä½“æ¶²ä¸­æœ‰è¾ƒé«˜çš„è“„ç§¯ã€‚è·¨åº¦æ¯”å°äº1è¡¨ç¤ºè¯ç‰©åœ¨ä½“æ¶²ä¸­çš„æµ“åº¦ä½äºè¡€æµ†ä¸­çš„æµ“åº¦ï¼Œè¡¨æ˜è¯ç‰©åœ¨ä½“æ¶²ä¸­çš„åˆ†å¸ƒè¾ƒå°‘ã€‚

Interpolation & Extrapolation, æ’å…¥/æ¨æ–­ã€‚


*Generally NCA will determine the following directly from the data:*
These properties are all based on observational data.

Cmax - Maximum observed concentration (units=concentration)
Tmax - The time where the maximum concentration was observed (units=time)
AUC - The area under the curve (units=time Ã— concentration)
AUMC - The area under the first moment curve (units = time2 Ã— concentration)

*å³ç„¶æ˜¯åŸºäºè§‚å¯Ÿæ•°æ®å¾—åˆ°çš„å€¼ï¼Œå…¶æœ¬èº«åªæ˜¯æ€»ä½“çš„ä¸€ä¸ªè¿‘ä¼¼ï¼Œè¿™é‡Œå˜å‡¸æ˜¾å‡ºæ¥å®éªŒè®¾è®¡çš„é‡è¦æ€§ï¼Œåˆç†çš„æ—¶é—´ç‚¹çš„è®¾ç½®*



*NCAé‡‡ç”¨çš„éçº¿æ€§æ¨¡å‹çš„å…·ä½“æ–¹æ³•ï¼š*
_ä»¥ä¸‹å†…å®¹æ¥è‡ªchatGPTï¼Œä¸ä¸€å®šæ­£ç¡®_
PK NCAï¼ˆNoncompartmental Analysisï¼‰æœ¬èº«å¹¶ä¸æ¶‰åŠéçº¿æ€§ç»Ÿè®¡æ¨¡å‹çš„æ‹Ÿåˆã€‚å®ƒæ˜¯ä¸€ç§åŸºäºæ•°å€¼ç§¯åˆ†å’Œç»Ÿè®¡æ–¹æ³•çš„éå‚æ•°åˆ†æï¼Œç”¨äºè®¡ç®—å’Œä¼°è®¡è¯ç‰©åœ¨ä½“å†…çš„æ›éœ²å’Œè¯ä»£åŠ¨åŠ›å­¦å‚æ•°ï¼Œè€Œæ— éœ€å‡è®¾å…·ä½“çš„è¯ç‰©åˆ†å¸ƒæ¨¡å‹ã€‚

PK NCAä¸»è¦åŸºäºè¯ç‰©çš„æµ“åº¦-æ—¶é—´æ•°æ®ï¼Œé€šè¿‡è®¡ç®—é¢ç§¯ä¸‹æ›²çº¿ï¼ˆAUCï¼‰å’Œå…¶ä»–å‚æ•°æ¥è¯„ä¼°è¯ç‰©çš„æ›éœ²ç¨‹åº¦ã€æ¶ˆé™¤é€Ÿç‡ã€å¸æ”¶é€Ÿåº¦ç­‰ã€‚è¿™äº›å‚æ•°çš„è®¡ç®—é€šå¸¸ä¸éœ€è¦é‡‡ç”¨éçº¿æ€§ç»Ÿè®¡æ¨¡å‹ã€‚

éçº¿æ€§ç»Ÿè®¡æ¨¡å‹é€šå¸¸åœ¨è¯ç‰©åŠ¨åŠ›å­¦å»ºæ¨¡å’Œè¯ç‰©ä»£è°¢åŠ¨åŠ›å­¦ï¼ˆPK/PDï¼‰å»ºæ¨¡ä¸­ä½¿ç”¨ï¼Œç”¨äºæè¿°è¯ç‰©åœ¨ä½“å†…çš„åŠ¨åŠ›å­¦è¿‡ç¨‹ï¼Œè€ƒè™‘å¸æ”¶ã€åˆ†å¸ƒã€ä»£è°¢å’Œæ’æ³„ç­‰å› ç´ ï¼Œå¹¶æ‹Ÿåˆå®é™…æ•°æ®ã€‚è¿™äº›æ¨¡å‹å¯ä»¥æ˜¯çº¿æ€§æ¨¡å‹æˆ–éçº¿æ€§æ¨¡å‹ï¼Œå¦‚ç”Ÿç†è¯åŠ¨æ¨¡å‹ï¼ˆPhysiologically Based Pharmacokinetic Modelï¼ŒPBPKï¼‰ã€åŒæŒ‡æ•°æ¨¡å‹ã€Michaelis-Mentenæ¨¡å‹ç­‰ã€‚è¿™äº›æ¨¡å‹éœ€è¦æ›´å¤æ‚çš„å‚æ•°ä¼°è®¡æ–¹æ³•ï¼Œé€šå¸¸ä½¿ç”¨éçº¿æ€§æœ€å°äºŒä¹˜æ‹Ÿåˆç­‰æŠ€æœ¯è¿›è¡Œå‚æ•°æ‹Ÿåˆã€‚

WinNonlinä¸­çš„PK NCAè®¡ç®—åŸºäºæ•°å€¼ç§¯åˆ†å’Œç»Ÿè®¡æ–¹æ³•ï¼Œä»¥è®¡ç®—å’Œä¼°è®¡è¯ç‰©åœ¨ä½“å†…çš„æ›éœ²å’Œè¯ä»£åŠ¨åŠ›å­¦å‚æ•°ã€‚æ›²çº¿ä¸‹é¢ç§¯ï¼ˆAUCï¼‰è®¡ç®—ï¼šWinNonliné‡‡ç”¨æ¢¯å½¢æ³•åˆ™ï¼ˆTrapezoidal Ruleï¼‰è¿›è¡ŒAUCçš„è®¡ç®—ã€‚å®ƒé€šè¿‡å¯¹æµ“åº¦-æ—¶é—´æ•°æ®è¿›è¡Œæ•°å€¼ç§¯åˆ†ï¼Œå°†æµ“åº¦-æ—¶é—´æ›²çº¿ä¸‹çš„é¢ç§¯è¿‘ä¼¼ä¸ºä¸€ç³»åˆ—æ¢¯å½¢çš„é¢ç§¯ä¹‹å’Œã€‚


*ä¸‰ç§æ•°æ®ç±»å‹ï¼š*
1. Sparse noncompartmental analysis (NCA)ï¼Œç†è§£èµ·æ¥ä¼¼ä¹å°±æ˜¯æ‹¼å‡‘èµ·æ¥çš„æ•°æ®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºç¼ºä¹æ¯ä¸ªä¸ªä½“çš„å®Œæ•´æ›²çº¿æ•°æ®ï¼Œ ä¼ ç»Ÿçš„éç»„åˆ†åˆ†ææ–¹æ³•å¯èƒ½æ— æ³•ç›´æ¥åº”ç”¨ã€‚ç¨€ç–NCAæ–¹æ³•æ—¨åœ¨è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»¥åœ¨æœ‰é™çš„æ•°æ®æƒ…å†µä¸‹å¯¹è¯ç‰©çš„è¯ä»£åŠ¨åŠ›å­¦è¿›è¡Œè¯„ä¼°ã€‚
2. Single dose
3. Multiple dose



```{r}
 # åŒæ ·å¯ä»¥ç”¨æ¥å¤„ç†PKæ•°æ®çš„RåŒ…,å…¶æ‰€æä¾›çš„NCAè®¡ç®—ä¹Ÿæ˜¯åŸºäºPKNCAçš„,è€Œä¸”å…¶æä¾›çš„ä¸€äº›æ–‡æ¡£è¿˜æ˜¯ä¸é”™çš„
# library(ubiquity)
# å…¶æä¾›çš„sparse NCAåˆ†æè„šæœ¬å€¼å¾—å‚è€ƒï¼Œå¾…å®Œæˆ

library(PKNCA)


# å…¶ä»–çš„ä¸€äº›æœ‰ç”¨çš„RåŒ…
library(PKData)

# éŸ©å›½ä¸€ä¸ªæœºæ„å‡ºå“çš„åŒ…
require(NonCompart)
require(ncar)
```


#### Single dose(å•æ¬¡ç»™è¯)

single dose å¯ä»¥ç†è§£ä¸ºvisitæ—¶æœŸå¼€å§‹çš„æ—¶é—´ï¼Œæ¯”å¦‚C1D1, C0D7ç­‰ç­‰ã€‚ä½†æ˜¯æ•°æ®é‡Œé¢çš„doseè¿˜ä¾æ—§æ˜¯å¯ä»¥å¤šä¸ªçš„ã€‚

å½“ç„¶æŒ‰ç…§PKNCAçš„æ–‡æ¡£ï¼ŒçœŸæ­£åªæœ‰ä¸€ä¸ªdoseçš„æ—¶å€™ï¼Œ`PKNCA.options("single.dose.aucs")`

ç¾åšæ‰€æä¾›çš„æ•°æ®:

```{r}
my_pk <- readxl::read_excel('~/OneDrive/kintor/Daily_Work/meibo_PK_pooled/8411-751_Concentration Table_01Jul2019.xls',
                            sheet = 'Concentration_individual',
                            skip = 3
                            ) %>% 
  janitor::remove_empty() %>% janitor::clean_names()
```

```{r}
my_pk1 <- my_pk %>% select(1:4) %>% 
  slice(-1)

my_pk2 <- my_pk %>% select(nominal_time_h:x16) %>% 
  set_names(slice(., 1)) %>% 
  slice(-1)

```

BQLç¼–ç ä¸º0ï¼Œmissing valueä¸ºNAï¼Œ
```{r}
pk_data <- my_pk1 %>% bind_cols(my_pk2) %>% 
  fill(c(visit,analyte,dose_level_mg),.direction = 'down')

pk_GT0918 <- pk_data %>% filter(analyte == 'GT0918',
                                visit == 'C1D1',
                                dose_level_mg == '200'
                                ) %>% 
  pivot_longer(cols = -(visit:subject),
               names_to = 'Time',
               values_to = 'conc'
               ) %>% 
  mutate(Time = as.numeric(Time),
         BLQ = if_else(conc == 'BQL', TRUE, FALSE),
         conc = ifelse(conc == 'BQL', 0, conc),
         conc = as.numeric(conc)
         )
```



*12ä¾‹æ‚£è€…ï¼Œæ¯ä¸€ä¸ªæ‚£è€…éƒ½åœ¨åŒä¸€ä¸ªdoseæµ“åº¦ä¸‹ï¼Œæµ‹é‡11ä¸ªæ—¶é—´ç‚¹çš„è¡€æ¸…æµ“åº¦æ•°æ®ã€‚*
```{r}
# 132ä¸ªè§‚æµ‹
head(datasets::Theoph)

Theoph <- Theoph %>% as.data.frame()
```

```{r}
# å¥½å¤šå¥½å¤šå¯ä¾›é€‰æ‹©çš„å†…å®¹
PKNCA.options()

# å¯ä»¥è®¾ç½®çš„intervals
get.interval.cols()

#
?pk.calc.auc
?pk.calc.aumc
?pk.calc.half.life
```


å•ä½è®¾ç½®
```{r}
d_units_auto <- pknca_units_table(concu="ng/mL", doseu="mg", amountu="mg", timeu="hr")

# å…¶å¯ä»¥å¯¹å•ä½è¿›è¡Œè‡ªåŠ¨çš„è½¬æ¢
# å‚æ•°ä¼ ç»™PKNCAdataå‡½æ•°
d_units <-
  pknca_units_table(
    concu="mg/L", doseu="mg/kg", timeu="hr",
    # use molar units for concentrations and AUCs
    conversions=
      data.frame(
        PPORRESU=c("(mg/kg)/(hr*mg/L)", "(mg/kg)/(mg/L)", "mg/L", "hr*mg/L"),
        PPSTRESU=c("L/hr/kg", "L/kg", "mmol/L", "hr*mmol/L"),
        conversion_factor=c(NA, NA, 1/180.164, 1/180.164)
      )
  )
```



ä»¥ä¸‹è®¡ç®—æ˜¯æŒ‰ç…§ID groupåˆ—åˆ†å¼€è®¡ç®—çš„ï¼ŒParameter calculation will automatically split the data by the grouping factor(s), subset by the interval, calculate all required parameters, record all options used for the calculations, and include data provenance to show that the calculation was performed as described. 
```{r}

# ä¸æ‰‹åŠ¨è®¾ç½®åˆ™ä¼šè‡ªåŠ¨è®¾ç½®
# è‡ªåŠ¨è®¾ç½®æ¯”è¾ƒç¨³å¥ï¼Œåœ¨ä½ è¿˜æ²¡æœ‰å…¨éƒ¨äº†è§£çš„æƒ…å†µä¸‹
# Intervals are subsets within a group by start and end time.
# intervalå¯ä»¥ç†è§£ä¸ºæ‰€æœ‰æ—¶é—´æ¢¯åº¦ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©å…¨éƒ¨
intervals <-
  data.frame(start=0, end=c(24, Inf),
             cmax=c(FALSE, TRUE),
             tmax=c(FALSE, TRUE),
             auclast=TRUE,
             aucinf.obs=c(FALSE, TRUE),
             mrt.iv.obs = c(FALSE, TRUE),
             mrt.iv.last = c(TRUE, FALSE),
             aumclast = TRUE,
             half.life = TRUE
             )

# ä¸åŒé‡‡æ ·æ—¶é—´ç‚¹çš„è¯ç‰©æµ“åº¦
# æ²¡æœ‰è€ƒè™‘ä¸åŒçš„dose
conc_obj <- PKNCA::PKNCAconc(pk_GT0918, conc~Time|subject)

#
# d_dose <- unique(datasets::Theoph[datasets::Theoph$Time == 0,
#                                   c("Dose", "Time", "Subject")])

# æœ¬æ­¥çš„ç›®çš„åªæ˜¯ä¸ºäº†å¾—åˆ°æ¯ä¸ªæ‚£è€…çš„doseä¿¡æ¯è€Œå·²
d_dose <- unique(pk_GT0918[pk_GT0918$Time == 0,
                                  c("dose_level_mg", "Time", "subject")])

# dose å’Œ æ—¶é—´ç‚¹
# ?PKNCAdose
dose_obj <- PKNCAdose(d_dose, dose_level_mg~Time|subject,
                      route = 'extravascular',#Define the route of administration."extravascular" or "intravascular" 
                      )

# ?PKNCAdata
data_obj_automatic <- PKNCAdata(conc_obj, 
                                dose_obj,
                                intervals = intervals
                                )

intervals_manual <- data_obj_automatic$intervals
```


```{r}
results_obj_automatic <- pk.nca(data_obj_automatic)

# è¾“å‡ºçš„ç»“æœç¬¦åˆ
# pharmacokinetic parameter (PP) TESTCD of CDISC SDTM
results_obj_automatic
# results_obj_automatic$result
```


```{r}
# Plot the concentration-time data and the interval
ggplot(pk_GT0918, aes(x=Time, y=conc)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, NA)) +
  labs(x="Time Since First Dose (hr)",
       y="Concentration\n(arbitrary units)")
```

```{r}
PKNCA.set.summary(
  name="half.life",
  description="arithmetic mean and standard deviation",
  point=business.mean,
  spread=business.sd,
  rounding=list(signif=3)
)

summary(results_obj_automatic) |> as.data.frame()

# summaryæä¾›çš„æ˜¯å¯¹ä¸Šè¡¨ä¸­å¤šä¸ªæ ·æœ¬çš„ç»Ÿè®¡å€¼ï¼ŒåŒ…æ‹¬å‡ ä½•å‡å€¼ç­‰ã€‚
# æ¯”å¦‚ä»¥ä¸‹åªå¯¹auclastè¿›è¡Œsummaryè®¡ç®—
results_obj_automatic$result %>% filter(PPTESTCD == 'auclast') %>% 
  summarise(across(PPORRES, c(PKNCA::geomean, PKNCA::geocv)))
```


*å¯¼å‡ºå®½æ•°æ®ï¼š*
```{r}
# as.data.frame(results_obj_automatic) == results_obj_automatic$result
results_obj_automatic$result %>% filter(end == 'Inf') %>% pivot_wider(id_cols = c(ru_zu_bian_hao, start, end),
                                                                      names_from = PPTESTCD,
                                                                      values_from = PPORRES
                                                                      )
```



*ä»¥ä¸‹è¿˜å¯ä»¥å•ç‹¬è®¡ç®—ï¼š*

AUC to the Last Value Above the Limit of Quantification (AUC~last~),
AUClastæ˜¯æŒ‡ï¼Œåœ¨tlastï¼ˆæœ€åä¸€ä¸ªéé›¶å€¼æ‰€å¯¹åº”çš„æ—¶é—´ç‚¹ï¼‰åˆ°æ—¶é—´ç‚¹ä¸º0çš„æ›²çº¿ä¸‹é¢ç§¯ã€‚

```{r}
# é¦–å…ˆæ˜¯æ‰¾åˆ°tlast
pk_GT0918_1subject  <- pk_GT0918 %>% filter(subject == 1021)

tlast <- pk.calc.tlast(conc=pk_GT0918_1subject$conc,
                       time=pk_GT0918_1subject$Time)
tlast
```


AUC~all~
åœ¨tlaståçš„ä¸€ä¸ªç‚¹è¿›è¡Œlinear interpolation to zeroåï¼Œæ±‚å¾—çš„ä»æ—¶é—´0å¼€å§‹çš„æ›²çº¿ä¸‹ç§¯åˆ†ã€‚

```{r}
first_after_tlast <- my_conc$time[my_conc$time > tlast][1]
first_after_tlast
```


AUC ~0-inf~

commonly used for single-dose data. It calculates the AUC0-last and then extrapolates to âˆ using the estimated half-life.
æ–‡æ¡£ä¸­çš„å›¾å¾ˆå¥½çš„è¯´æ˜äº†è¿™ä¸€AUCæ‰€å¯¹åº”çš„é¢ç§¯ã€‚
å’ŒAUC_all_ç›¸æ¯”ï¼ˆå¯ä»¥ç®€å•çš„ç†è§£ä¸ºæ›²çº¿ä¸‹çš„é¢ç§¯ï¼‰ï¼Œå…¶æ›´åƒæ˜¯ä»half-lifeæ¨æµ‹å‡ºçš„å»¶é•¿çº¿è€Œå¾—åˆ°çš„æ›²çº¿ä¸‹é¢ç§¯ï¼Œä¸€èˆ¬è€Œè¨€å…¶æ¯”AUC~all~çš„å€¼è¦å¤§ä¸€äº›ã€‚

```{r}

```


Half-Life Calculation

> https://billdenney.github.io/pknca/articles/v06-half-life-calculation.html

åŠè¡°æœŸçš„è®¡ç®—æ˜¯å¯¹concentrationå–è‡ªç„¶å¯¹æ•°çš„logåå’Œæ—¶é—´æ‹Ÿåˆæ›²çº¿ã€‚The default calculation method is curve strippingã€‚
ä¼¼ä¹å°±æ˜¯é€‰æ‹©ä¸åŒçš„ç‚¹æ‹Ÿåˆä¸åŒçš„æ¨¡å‹ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªbest fitã€‚

```{r}
PKNCA.options("min.hl.points")

PKNCA.options("allow.tmax.in.half.life")
```



*use another package:*
å…¶çš„ç»“æœå’ŒWinNonlin çš„ç»“æœä¿æŒä¸€è‡´ï¼Œå°¤å…¶æ˜¯AUCçš„éƒ¨åˆ†ã€‚
å…¶å¯¹åªæœ‰ä¸€ä¸ªæ‚£è€…çš„æ•°æ®ï¼Œå’Œå¤šä¸ªæ‚£è€…çš„æ•°æ®æ˜¯ç”¨ä¸åŒçš„å‡½æ•°åˆ†æçš„ã€‚
```{r}
NonCompart::tblNCA(Theoph, key = "Subject", colTime = "Time", colConc = "conc", 
                   dose = 320, # Doseå¯¹ä¸åŒçš„æ‚£è€…ä¸ä¸€è‡´å’‹åŠå‘¢ï¼Ÿæ¯ä¸ªæ ·æœ¬ä¸€ä¸ªæµ“åº¦æ˜¯å¯è¡Œçš„
                   adm = "Extravascular", dur = 0, doseUnit = "mg", timeUnit = "h", concUnit = "mg/L", 
                   down = "Linear")
```


```{r}
# æ³¨æ„ç›®å‰éœ€è¦data.frameæ ¼å¼ï¼Œtibbleçš„è¯éœ€è¦æ”¹ä¸€ä¸‹
# è€Œä¸”å¦‚æœæ•°æ®è´¨é‡ä¸è¡Œçš„è¯ï¼Œä¼šè®¡ç®—å‡ºå¾ˆå¤šçš„NAå€¼

Time = Theoph[Theoph$Subject == 8, "Time"]
Concentration = Theoph[Theoph$Subject == 8, "conc"]
Res = sNCA(Time, Concentration,dose = 320, concUnit = "mg/L")
IntAUC(Time, Concentration, t1 = 0.5, t2 = 11, Res)
```


```{r}
ncar::pdfNCA(fileName = "pdfNCA-Theoph.pdf", Theoph, key = "Subject", 
       colTime = "Time", colConc = "conc", dose = 320, doseUnit = "mg", 
       timeUnit = "h", concUnit = "mg/L", down = "Linear")

# ncar::pdfNCA(fileName = "~/OneDrive/kintor/Daily_Work/GT1708F_CN2001/pdfNCA-GT1708F.pdf", 
#              cal_pk_c0d1, key = "ru_zu_bian_hao", 
#              colTime = "ji_hua_shi_jian_dian", colConc = "pk_nong_du", 
#              dose = aa, 
#              doseUnit = "mg", timeUnit = "h", concUnit = "mg/L", 
#              down = "Linear"
#              )
# 
# ncar::rtfNCA(fileName = "~/OneDrive/kintor/Daily_Work/GT1708F_CN2001/pdfNCA-GT1708F.rtf", 
#              cal_pk_c0d1, key = "ru_zu_bian_hao", 
#              colTime = "ji_hua_shi_jian_dian", colConc = "pk_nong_du", 
#              dose = aa, 
#              doseUnit = "mg", timeUnit = "h", concUnit = "mg/L", 
#              down = "Linear"
#              )
```



#### Multi doseï¼ˆå¤šæ¬¡ç»™è¯ï¼‰

å¯¹äºMulti doseçš„ç†è§£å°±æ˜¯ï¼Œé€‰æ‹©æœ€åä¸€æœŸvisitæ—¶æœŸã€‚

multiple-dose studyä¸ªäººç›®å‰å€¾å‘äºç†è§£ä¸ºï¼Œä¸€ä¸ªæ‚£è€…é‡‡é›†äº†å¤šä¸ªdoseçš„æ•°æ®ã€‚å³æ˜¯å¤šæ¬¡ç»™è¯ã€‚

å¤šæ¬¡ç»™è¯åçš„ç¨³æ€ä½œä½•ç†è§£å‘¢ï¼Ÿ

```{r}
?superposition
```




