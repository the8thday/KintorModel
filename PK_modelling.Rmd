---
title: "pharmacokinetics modelling"
author: "liuc"
date: "1/12/2022"
output: pdf_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## pharmacokinetics modelling by R

> <http://sia.webpopix.org/pharmacokinetics.html>
> <http://sia.webpopix.org/nlme.html>
>
> 熟悉nlmixr2包的文档
>
> <https://www.pkpd-info.com/PK_introduction.php>
> <http://opensource.nibr.com/xgx/index.html>
> https://cran.r-project.org/web/views/Pharmacokinetics.html
> https://discuss.go-isop.org/
> https://cran.r-project.org/web/packages/ubiquity/vignettes/NCA.html




Once a drug is administered, we usually describe subsequent processes
within the organism by the pharmacokinetics (PK) process known as ADME:
absorption, distribution, metabolism, excretion.
具体的关于PK的一些描述可以参见第四个链接。

将人体简化为depot compartment。PK compartment models assume that drug
concentration is perfectly homogeneous in each compartment of the body
at all times.

PK models do not describe how a drug is administered. Administered doses
are source terms, i.e., inputs that dynamically modify the state of a
system. This is important to note because it means that the same PK
model can be used for different dose regimens.

ordinary differential equations (ODEs):

PK模型有很多，但非线性混合模型是PK建模中常用的模型。下面以一个测试数据集进行初步的学习，此处做一笔记。

k : rate constants (kinetic) --\> movement from 'x' to 'y' Ka:
absorption constant Vc: distribution compartment (central) Q: rate
constant between Vc and Vp Vp: distribution compartment (periph.) CL:
elimination constant (clearance) Described by differential equations of
change in compartment (A) over time (T): dA/dT

对于非线性混合效应模型，The system will support but not be limited to
the following estimation methods: FO, FOI, FOCE, FOCEI, Laplacian,
Lindstrom and Bates, MCMC, MCPEM, SAEM, Gaussian quadrature, and
nonparametric methods。

```{r, include=FALSE}
library(tidyverse)
# library(saemix)
# library(nlmixr) # 主要学习的R包，不过和2的版本不兼容，二者先library一个
library(nlmixr2) # 目前看起来是一个整合了多种nlme的包
library(rxode2)
library(nlmixr2data)
library(ggPMX)
library(xpose)

# library('nonmem2R')
library(xgxr) # 诺华 提供的一个探索性R包

```

### use nlmixr2 package

#### single-dose

fitting a simple one-compartment PK model use `nlmixr2` package.

one-compartment指的是，

下面的模型中，和在使用`saemix`包时是一致的，包括模型和起始值。`nlmixr2`包的语法和ini的命名系统是模仿的NONMEM软件。在ini中设置值时一般的是一个值，或者三个值（c(lower,
est, upper)）,`~`是方差或相关性，`<-`是参数赋值,`#`后面的内容是
label的内容会在Parameter展现，也可以用label函数。

其中，model部分的意思是：A mathematical model which best describes the
data

theo_sd是常见的theophylline数据集，是longitudinal repeated measures
data，每一个个体其随时间测得的血药浓度在PK 中都是非线性的。 The form of
the nonlinear model is determined by the pharmacokinetic theory, not
derived from the data.
但是依据PK理论所得到的每一个个体的PK参数是有变化的，不同的，所以还要考虑population，引入个体间的random
effect。
在`nlmixr2`中数据的列名是有要求的吗？毕竟文档的示例中直接就输入了数据名。。在saemix中尚且需要指定数据。

```{r}
#  ordinary differential equations (ODEs) model
one.compartment.saem <- function() {
    ini({
        tka <- .5   # Log Ka
        tcl <- -3.2 # Log Cl
        tv <- -1    # Log V
        eta.ka ~ 1 ## BSV Ka
        eta.cl ~ 2
        eta.v ~ 1
        add.err <- 0.1 # residual variability
    })
    model({
        ka <- exp(tka + eta.ka)
        cl <- exp(tcl + eta.cl)
        v <- exp(tv + eta.v)
        d/dt(depot) = -ka * depot
        d/dt(center) = ka * depot - cl / v * center
        cp = center / v 
        cp ~ add(add.err)
    })
}

# 数据集相关的变量啥也不用指定吗？？
fit <- nlmixr2(one.compartment.saem, 
               data = theo_sd, 
               est="saem" # nlmixr2est::nlmixr2AllEst()
               )

```

```{r}
print(fit)
```

base plot:

```{r}
plot(fit)
```

除上述通过`base`包得到的诊断图之外，还提供了`xpose`包的使用，`xpose`包是aims
to reduce the post processing burden and improve diagnostics commonly
associated the development of non-linear mixed effect models.

```{r}
library(xpose.nlmixr2)

xpdb <- xpose_data_nlmixr(fit) # 此object可以使用xpose包的函数

xpose::dv_vs_ipred(xpdb)
```

#### multi-dose

```{r}

```

### use PKNCA 包

此包主要是提供non-compartmental analysis (NCA) PK计算方法, NCA is used
as method of description of PK with minimal assumptions of the rates of
distribution of the drug through the body. NCA is typically used to
describe the PK of a drug in clinical studies with many samples per
subject on the same and sequential days.

以我这两天查资料的情况来看，NCA和上文的modeling方法还是不一样的。顾名思义，一个把人体理解为compartment，一个没有。

其需要两个数据集，分别是浓度数据集和dose数据集，对于每个数据集中的分类变量，其的语法为：concentration, dose, and time must all be numeric.


*NCA的一些资料收集：*

只要药物符合线性药物动力学，不管它属于什么样的隔室模型，都能使用非房室方法。非房室模型是临床计算PK参数的主要方法。
WinNonlin中非房室模型分析，以概率论和数理统计学中的统计矩方法为理论基础，对数据进行解析，主要包括零阶矩和一阶矩。

其中不依赖末端消除速率λz的参数有药峰浓度（Cmax），达峰时间（Tmax），最后一个可定量点所对应的时间点（Tlast）和药物浓度（Clast），这些参数不依赖于计算，而是直接由观测值得出。还有从0时刻到最后一个可定量点所对应的曲线下面积（AUClast），一阶矩平均驻留时间（MRT），反应了药物在体内的平均停留时间。


*一些概念的理清：*
AUClast(Area Under the Curve)：AUClast是药物生物利用度描述指标，也就是逐点法计算得到的从给药开始到最后测量得到测定浓度（Clast）的药物暴露程度。即药物在体内的暴露程度，反映药物的吸收程度。AUClast是指药物在最后一个可测量时间点（通常为最后一个采样时间点）前的曲线下面积。它反映了药物在体内的总体曝露程度，即药物在体内的浓度随时间的积累情况。AUClast可以通过计算药物浓度与时间的曲线下的面积来获得。

Cmax(Maximum Concentration)：药物吸收后，体内浓度达到最大值即为Cmax。一般来说，Cmax越大，说明药物吸收越快越全。它是一个用来描绘给药后药物浓度-时间曲线（concentration-time curve）的重要参数。 Cmax通常用来评估药物的吸收速度和程度，对于药物的疗效和安全性具有重要意义。*Cmax似乎就是时间梯度中最大的那个值，且来自观测数据本身，不是模型拟合计算得来的。*

Clast：Clast是指在给药后的最后测定时刻所测得的药物浓度，也就是药物在体内吸收过程的最后测定点的血药浓度。clast通常用于评估药物在体内的消除速度和半衰期。*其也是直接提取的raw data中的数据*

Tmax(Time to Maximum Concentration)：这是药物达到最大浓度的时间。这通常是一个反映药物吸收速度的重要指标。*来自数据本身*

AUC0-∞：这是从给药开始到无穷远的预测药物全身暴露程度。平均来说，AUC0-∞相比AUClast能更好地反映药物的全部体内暴露程度。它反映了药物在体内的总体曝露程度，包括药物的吸收、分布、代谢和排泄过程。

T1/2(Half-life) ：这是药物半衰期，表示药物浓度减半所需的时间。这个数字反映了药物从体内消除的速度。

CL(Clearance)：清除率，衡量体内清除药物的能力。它可以反映药物的代谢和排泄情况。清除率越高，药物在体内的停留时间越短。
$CL=Dose/AUC$

Vd(volume of distribution)：分布容积，反映药物在体内分布的广度。

MRT(Mean residence time): $MRT=AUMC/AUC$, 表示药物在体内平均停留的时间

Vss(Steady state volume of distribution): $Vss = MRT × CL$ , 稳态分布容积）是一个用于描述药物在体内分布的参数，通常用符号Vss表示。它表示在稳态条件下，使血浆中的药物浓度达到平衡所需的药物总量与血浆中的药物浓度之间的关系。

"lambda" 通常用于表示药物的消除速率常数（elimination rate constant）。消除速率常数是衡量药物从体内清除的速度的指标，它表示在单位时间内药物浓度减少的比例。

"tlag" 在药物药代动力学中是指药物在给药后进入循环系统的延迟时间（lagtime）。它表示从给药到药物开始出现在血液中测量到的浓度的时间间隔。

AUMCinf（Area Under the Moment Curve at Infinity）是指药物的无限时刻矩时刻曲线下的面积。 它是PK（Pharmacokinetics，药物药代动力学）中的一个衡量参数，用于描述药物在体内的总体暴露程度和分布。AUMCinf是通过计算药物浓度-时间曲线的矩时刻曲线下的面积来获得的。矩时刻曲线是将时间的各个次幂乘以对应时间点上的药物浓度所得到的曲线。AUMCinf通常与AUCinf（Area Under the Concentration Curve at Infinity，无限时刻浓度曲线下的面积）一起使用，以提供更全面的药物暴露和药代动力学信息。


*Generally NCA will determine the following directly from the data:*
These properties are all based on observational data.

Cmax - Maximum observed concentration (units=concentration)
Tmax - The time where the maximum concentration was observed (units=time)
AUC - The area under the curve (units=time × concentration)
AUMC - The area under the first moment curve (units = time2 × concentration)

*即然是基于观察数据得到的值，其本身只是总体的一个近似，这里变凸显出来实验设计的重要性，合理的时间点的设置*



*NCA采用的非线性模型的具体方法：*
_以下内容来自chatGPT，不一定正确_
PK NCA（Noncompartmental Analysis）本身并不涉及非线性统计模型的拟合。它是一种基于数值积分和统计方法的非参数分析，用于计算和估计药物在体内的曝露和药代动力学参数，而无需假设具体的药物分布模型。

PK NCA主要基于药物的浓度-时间数据，通过计算面积下曲线（AUC）和其他参数来评估药物的曝露程度、消除速率、吸收速度等。这些参数的计算通常不需要采用非线性统计模型。

非线性统计模型通常在药物动力学建模和药物代谢动力学（PK/PD）建模中使用，用于描述药物在体内的动力学过程，考虑吸收、分布、代谢和排泄等因素，并拟合实际数据。这些模型可以是线性模型或非线性模型，如生理药动模型（Physiologically Based Pharmacokinetic Model，PBPK）、双指数模型、Michaelis-Menten模型等。这些模型需要更复杂的参数估计方法，通常使用非线性最小二乘拟合等技术进行参数拟合。

WinNonlin中的PK NCA计算基于数值积分和统计方法，以计算和估计药物在体内的曝露和药代动力学参数。曲线下面积（AUC）计算：WinNonlin采用梯形法则（Trapezoidal Rule）进行AUC的计算。它通过对浓度-时间数据进行数值积分，将浓度-时间曲线下的面积近似为一系列梯形的面积之和。


*三种数据类型：*



```{r}
# library(ubiquity) # 同样可以用来处理PK数据的R包,其所提供的NCA计算也是基于PKNCA的
# 而且其提供的一些文档还是不错的
library(PKNCA)


# 其他的一些有用的R包
library(PKData)

# 韩国一个机构出品的包
require(NonCompart)
require(ncar)
```


#### Single dose

single dose 可以理解为visit时期开始的时间，比如C1D1, C0D7等等。但是数据里面的dose还依旧是可以多个的。

当然按照PKNCA的文档，真正只有一个dose的时候，`PKNCA.options("single.dose.aucs")`

美博所提供的数据:

```{r}
my_pk <- readxl::read_excel('~/OneDrive/kintor/Daily_Work/meibo_PK_pooled/8411-751_Concentration Table_01Jul2019.xls',
                            sheet = 'Concentration_individual',
                            skip = 3
                            ) %>% 
  janitor::remove_empty() %>% janitor::clean_names()
```

```{r}
my_pk1 <- my_pk %>% select(1:4) %>% 
  slice(-1)

my_pk2 <- my_pk %>% select(nominal_time_h:x16) %>% 
  set_names(slice(., 1)) %>% 
  slice(-1)

```

BQL编码为0，missing value为NA，
```{r}
pk_data <- my_pk1 %>% bind_cols(my_pk2) %>% 
  fill(c(visit,analyte,dose_level_mg),.direction = 'down')

pk_GT0918 <- pk_data %>% filter(analyte == 'GT0918',
                                visit == 'C1D1',
                                dose_level_mg == '200'
                                ) %>% 
  pivot_longer(cols = -(visit:subject),
               names_to = 'Time',
               values_to = 'conc'
               ) %>% 
  mutate(Time = as.numeric(Time),
         BLQ = if_else(conc == 'BQL', TRUE, FALSE),
         conc = ifelse(conc == 'BQL', 0, conc),
         conc = as.numeric(conc)
         )
```



*12例患者，每一个患者都在同一个dose浓度下，测量11个时间点的血清浓度数据。*
```{r}
# 132个观测
head(datasets::Theoph)

Theoph <- Theoph %>% as.data.frame()
```

```{r}
# 好多好多可供选择的内容
PKNCA.options()

# 可以设置的intervals
get.interval.cols()

#
?pk.calc.auc
?pk.calc.aumc
?pk.calc.half.life
```

```{r}

# 不手动设置则会自动设置
# 自动设置比较稳健，在你还没有全部了解的情况下
# Intervals are subsets within a group by start and end time.
# interval可以理解为所有时间梯度中的一部分，当然也可以选择全部
intervals <-
  data.frame(start=0, end=c(24, Inf),
             cmax=c(FALSE, TRUE),
             tmax=c(FALSE, TRUE),
             auclast=TRUE,
             aucinf.obs=c(FALSE, TRUE),
             mrt.iv.obs = c(FALSE, TRUE),
             mrt.iv.last = c(TRUE, FALSE),
             aumclast = TRUE,
             half.life = TRUE
             )

# 不同采样时间点的药物浓度
# 没有考虑不同的dose
conc_obj <- PKNCA::PKNCAconc(pk_GT0918, conc~Time|subject)

#
# d_dose <- unique(datasets::Theoph[datasets::Theoph$Time == 0,
#                                   c("Dose", "Time", "Subject")])

# 本步的目的只是为了得到每个患者的dose信息而已
d_dose <- unique(pk_GT0918[pk_GT0918$Time == 0,
                                  c("dose_level_mg", "Time", "subject")])

# dose 和 时间点
# ?PKNCAdose
dose_obj <- PKNCAdose(d_dose, dose_level_mg~Time|subject,
                      route = 'extravascular',#Define the route of administration."extravascular" or "intravascular" 
                      )

# ?PKNCAdata
data_obj_automatic <- PKNCAdata(conc_obj, 
                                dose_obj,
                                intervals = intervals
                                )

intervals_manual <- data_obj_automatic$intervals
```


```{r}
results_obj_automatic <- pk.nca(data_obj_automatic)

# 输出的结果符合
# pharmacokinetic parameter (PP) TESTCD of CDISC SDTM
results_obj_automatic
# results_obj_automatic$result
```

```{r}
PKNCA.set.summary(
  name="half.life",
  description="arithmetic mean and standard deviation",
  point=business.mean,
  spread=business.sd,
  rounding=list(signif=3)
)

summary(results_obj_automatic) |> as.data.frame()

# summary提供的是对上表中多个样本的统计值，包括几何均值等。
# 比如以下只对auclast进行summary计算
results_obj_automatic$result %>% filter(PPTESTCD == 'auclast') %>% 
  summarise(across(PPORRES, c(PKNCA::geomean, PKNCA::geocv)))
```


*导出宽数据：*
```{r}
results_obj_automatic$result %>% filter(end == 'Inf') %>% pivot_wider(id_cols = c(ru_zu_bian_hao, start, end),
                                                                      names_from = PPTESTCD,
                                                                      values_from = PPORRES
                                                                      )
```



AUC to the Last Value Above the Limit of Quantification (AUC~last~)

```{r}
pk_GT0918_1subject  <- pk_GT0918 %>% filter(subject == 1021)

tlast <- pk.calc.tlast(conc=pk_GT0918_1subject$conc,
                       time=pk_GT0918_1subject$Time)
tlast
```


AUC~all~

```{r}
first_after_tlast <- my_conc$time[my_conc$time > tlast][1]
first_after_tlast
```


AUC ~0-inf~

commonly used for single-dose data. It calculates the AUC0-last and then extrapolates to ∞ using the estimated half-life. 
```{r}

```


*use another package:*
其的结果和WinNonlin 的结果保持一致，尤其是AUC的部分。
其对只有一个患者的数据，和多个患者的数据是用不同的函数分析的。
```{r}
NonCompart::tblNCA(Theoph, key = "Subject", colTime = "Time", colConc = "conc", 
                   dose = 320, # Dose对不同的患者不一致咋办呢？每个样本一个浓度是可行的
                   adm = "Extravascular", dur = 0, doseUnit = "mg", timeUnit = "h", concUnit = "mg/L", 
                   down = "Linear")
```


```{r}
# 注意目前需要data.frame格式，tibble的话需要改一下
# 而且如果数据质量不行的话，会计算出很多的NA值

Time = Theoph[Theoph$Subject == 8, "Time"]
Concentration = Theoph[Theoph$Subject == 8, "conc"]
Res = sNCA(Time, Concentration,dose = 320, concUnit = "mg/L")
IntAUC(Time, Concentration, t1 = 0.5, t2 = 11, Res)
```


```{r}
ncar::pdfNCA(fileName = "pdfNCA-Theoph.pdf", Theoph, key = "Subject", 
       colTime = "Time", colConc = "conc", dose = 320, doseUnit = "mg", 
       timeUnit = "h", concUnit = "mg/L", down = "Linear")

# ncar::pdfNCA(fileName = "~/OneDrive/kintor/Daily_Work/GT1708F_CN2001/pdfNCA-GT1708F.pdf", 
#              cal_pk_c0d1, key = "ru_zu_bian_hao", 
#              colTime = "ji_hua_shi_jian_dian", colConc = "pk_nong_du", 
#              dose = aa, 
#              doseUnit = "mg", timeUnit = "h", concUnit = "mg/L", 
#              down = "Linear"
#              )
# 
# ncar::rtfNCA(fileName = "~/OneDrive/kintor/Daily_Work/GT1708F_CN2001/pdfNCA-GT1708F.rtf", 
#              cal_pk_c0d1, key = "ru_zu_bian_hao", 
#              colTime = "ji_hua_shi_jian_dian", colConc = "pk_nong_du", 
#              dose = aa, 
#              doseUnit = "mg", timeUnit = "h", concUnit = "mg/L", 
#              down = "Linear"
#              )
```



#### Multi dose

对于Multi dose的理解就是，选择最后一期visit时期。

multiple-dose study个人目前倾向于理解为，一个患者采集了多个dose的数据。

```{r}

```




