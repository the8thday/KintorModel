---
title: "pharmacokinetics modelling"
author: "liuc"
date: "1/12/2022"
output: pdf_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## pharmacokinetics modelling by R

> <http://sia.webpopix.org/pharmacokinetics.html>
> <http://sia.webpopix.org/nlme.html>
>
> 熟悉nlmixr2包的文档
>
> <https://www.pkpd-info.com/PK_introduction.php>
> <http://opensource.nibr.com/xgx/index.html>

Once a drug is administered, we usually describe subsequent processes
within the organism by the pharmacokinetics (PK) process known as ADME:
absorption, distribution, metabolism, excretion.
具体的关于PK的一些描述可以参见第四个链接。

将人体简化为depot compartment。PK compartment models assume that drug
concentration is perfectly homogeneous in each compartment of the body
at all times.

PK models do not describe how a drug is administered. Administered doses
are source terms, i.e., inputs that dynamically modify the state of a
system. This is important to note because it means that the same PK
model can be used for different dose regimens.

ordinary differential equations (ODEs):

PK模型有很多，但非线性混合模型是PK建模中常用的模型。下面以一个测试数据集进行初步的学习，此处做一笔记。

k : rate constants (kinetic) --\> movement from 'x' to 'y' Ka:
absorption constant Vc: distribution compartment (central) Q: rate
constant between Vc and Vp Vp: distribution compartment (periph.) CL:
elimination constant (clearance) Described by differential equations of
change in compartment (A) over time (T): dA/dT

对于非线性混合效应模型，The system will support but not be limited to
the following estimation methods: FO, FOI, FOCE, FOCEI, Laplacian,
Lindstrom and Bates, MCMC, MCPEM, SAEM, Gaussian quadrature, and
nonparametric methods。

```{r, include=FALSE}
library(tidyverse)
# library(saemix)
# library(nlmixr) # 主要学习的R包，不过和2的版本不兼容，二者先library一个
library(nlmixr2) # 目前看起来是一个整合了多种nlme的包
library(rxode2)
library(nlmixr2data)
library(ggPMX)
# library(ubiquity)
library(PKNCA)
library(xpose)

# library('nonmem2R')
library(xgxr) # 诺华 提供的一个探索性R包

```

### use nlmixr2 package

#### single-dose

fitting a simple one-compartment PK model use `nlmixr2` package.

one-compartment指的是，

下面的模型中，和在使用`saemix`包时是一致的，包括模型和起始值。`nlmixr2`包的语法和ini的命名系统是模仿的NONMEM软件。在ini中设置值时一般的是一个值，或者三个值（c(lower,
est, upper)）,`~`是方差或相关性，`<-`是参数赋值,`#`后面的内容是
label的内容会在Parameter展现，也可以用label函数。

其中，model部分的意思是：A mathematical model which best describes the
data

theo_sd是常见的theophylline数据集，是longitudinal repeated measures
data，每一个个体其随时间测得的血药浓度在PK 中都是非线性的。 The form of
the nonlinear model is determined by the pharmacokinetic theory, not
derived from the data.
但是依据PK理论所得到的每一个个体的PK参数是有变化的，不同的，所以还要考虑population，引入个体间的random
effect。
在`nlmixr2`中数据的列名是有要求的吗？毕竟文档的示例中直接就输入了数据名。。在saemix中尚且需要指定数据。

```{r}
#  ordinary differential equations (ODEs) model
one.compartment.saem <- function() {
    ini({
        tka <- .5   # Log Ka
        tcl <- -3.2 # Log Cl
        tv <- -1    # Log V
        eta.ka ~ 1 ## BSV Ka
        eta.cl ~ 2
        eta.v ~ 1
        add.err <- 0.1 # residual variability
    })
    model({
        ka <- exp(tka + eta.ka)
        cl <- exp(tcl + eta.cl)
        v <- exp(tv + eta.v)
        d/dt(depot) = -ka * depot
        d/dt(center) = ka * depot - cl / v * center
        cp = center / v 
        cp ~ add(add.err)
    })
}

# 数据集相关的变量啥也不用指定吗？？
fit <- nlmixr2(one.compartment.saem, 
               data = theo_sd, 
               est="saem" # nlmixr2est::nlmixr2AllEst()
               )

```

```{r}
print(fit)
```

base plot:

```{r}
plot(fit)
```

除上述通过`base`包得到的诊断图之外，还提供了`xpose`包的使用，`xpose`包是aims
to reduce the post processing burden and improve diagnostics commonly
associated the development of non-linear mixed effect models.

```{r}
library(xpose.nlmixr2)

xpdb <- xpose_data_nlmixr(fit) # 此object可以使用xpose包的函数

xpose::dv_vs_ipred(xpdb)
```

#### multi-dose

```{r}

```

### use PKNCA 包

此包主要是提供non-compartmental analysis (NCA) PK计算方法, NCA is used
as method of description of PK with minimal assumptions of the rates of
distribution of the drug through the body. NCA is typically used to
describe the PK of a drug in clinical studies with many samples per
subject on the same and sequential days.

以我这两天查资料的情况来看，NCA和上文的modeling方法还是不一样的。顾名思义，一个把人体理解为compartment，一个没有。

其需要两个数据集，分别是浓度数据集和dose数据集，对于每个数据集中的分类变量，其的语法为：

```{r}
library(PKData)
```


#### Single dose

single dose 可以理解为visit时期开始的时间，比如C1D1, C0D7等等。

美博所提供的数据:

```{r}
my_pk <- readxl::read_excel('~/OneDrive/kintor/Daily_Work/meibo_PK_pooled/8411-751_Concentration Table_01Jul2019.xls',
                            sheet = 'Concentration_individual',
                            skip = 3
                            ) %>% 
  janitor::remove_empty() %>% janitor::clean_names()
```

```{r}
my_pk1 <- my_pk %>% select(1:4) %>% 
  slice(-1)

my_pk2 <- my_pk %>% select(nominal_time_h:x16) %>% 
  set_names(slice(., 1)) %>% 
  slice(-1)

```

```{r}
pk_data <- my_pk1 %>% bind_cols(my_pk2) %>% 
  fill(c(visit,analyte,dose_level_mg),.direction = 'down')

pk_GT0918 <- pk_data %>% filter(analyte == 'GT0918',
                                visit == 'C1D1',
                                dose_level_mg == '200'
                                ) %>% 
  pivot_longer(cols = -(visit:subject),
               names_to = 'Time',
               values_to = 'conc'
               ) %>% 
  mutate(Time = as.numeric(Time),
         BLQ = if_else(conc == 'BQL', TRUE, FALSE),
         conc = ifelse(conc == 'BQL', 0, conc),
         conc = as.numeric(conc)
         )
```

*12例患者，每一个患者都在同一个dose浓度下，测量11个时间点的血清浓度数据。*


```{r}
head(datasets::Theoph)

Theoph <- Theoph %>% as.data.frame()
```

```{r}
# 好多好多
PKNCA.options()

# 可以设置的intervals
get.interval.cols()
```

```{r}

intervals <-
  data.frame(start=0, end=c(24, Inf),
             cmax=c(FALSE, TRUE),
             tmax=c(FALSE, TRUE),
             auclast=TRUE,
             aucinf.obs=c(FALSE, TRUE),
             mrt.iv.obs = c(FALSE, TRUE),
             mrt.iv.last = c(TRUE, FALSE),
             aumclast = TRUE,
             half.life = TRUE
             )

# 
conc_obj <- PKNCA::PKNCAconc(pk_GT0918, conc~Time|subject)

#
# d_dose <- unique(datasets::Theoph[datasets::Theoph$Time == 0,
#                                   c("Dose", "Time", "Subject")])

d_dose <- unique(pk_GT0918[pk_GT0918$Time == 0,
                                  c("dose_level_mg", "Time", "subject")])

dose_obj <- PKNCAdose(d_dose, dose_level_mg~Time|subject)

data_obj_automatic <- PKNCAdata(conc_obj, dose_obj,
                                intervals = intervals
                                )
```


```{r}
results_obj_automatic <- pk.nca(data_obj_automatic)

results_obj_automatic
# results_obj_automatic$result
```

```{r}
PKNCA.set.summary(
  name="half.life",
  description="arithmetic mean and standard deviation",
  point=business.mean,
  spread=business.sd,
  rounding=list(signif=3)
)

summary(results_obj_automatic) |> as.data.frame()

# summary提供的是对上表中多个样本的统计值，包括几何均值等。
results_obj_automatic$result %>% filter(PPTESTCD == 'auclast') %>% 
  summarise(across(PPORRES, c(PKNCA::geomean, PKNCA::geocv)))
```


AUC to the Last Value Above the Limit of Quantification (AUC~last~)

```{r}
pk_GT0918_1subject  <- pk_GT0918 %>% filter(subject == 1021)

tlast <- pk.calc.tlast(conc=pk_GT0918_1subject$conc,
                       time=pk_GT0918_1subject$Time)
tlast
```


AUC~all~

```{r}
first_after_tlast <- my_conc$time[my_conc$time > tlast][1]
first_after_tlast
```


AUC ~0-inf~

commonly used for single-dose data. It calculates the AUC0-last and then extrapolates to ∞ using the estimated half-life. 
```{r}

```


#### Multi dose


```{r}

```




